<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>MadaCoin MCD</title>
  <meta name="description" content="MadaCoin støtter udvikling i Madagaskar gennem donationer og gennemsigtighed.">
  <link id="favicon" rel="icon" href="/favicon_boosted.ico?v=1" type="image/x-icon">

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    *,*::before,*::after{ box-sizing:border-box }
    html,body{ height:100% }

    :root{
      /* Layout */
      --edge:24px;
      --container:1200px;

      /* Nav */
      --nav-gap:14px; --nav-px:14px; --nav-py:8px;
      --nav-bg:#0d0d0f; --nav-b:#333; --nav-hover:#151517; --nav-active:#5aa9ff;

      /* Venstre kolonne (Hero) */
      --left-col:520px;
      --social-top:106px;
      --left-rail-nudge:-100px;
      --left-rail-top: calc(var(--social-top) + var(--left-rail-nudge));
      --left-rail-left: -260px;

      /* Højre kolonne (mønter+YouTube) – låst */
      --right-rail-left: 538px;

      /* Body gradient */
      --base-top:#eff3fb;
      --base-bot:#e2ebf7;

      /* Baggrund (samme motor som About) */
      --bg:#061a2b;
      --bg-image:url('https://byrlebjwknppjbtbkozt.supabase.co/storage/v1/object/public/backgrounds/ocean.png');
      --bg-1x: var(--bg-image);
      --bg-2x: var(--bg-image);

      /* Pos tweak til baggrund (kan justeres) */
      --bg-x: 0px;
      --bg-y: 0px;
    }

    /* ===================== BODY / BAGGRUND ===================== */
    body{
      display:flex; flex-direction:column; margin:0; color:#fff;
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;

      /* Lag: overlay + image-set (1x/2x) + gradient */
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.14)),
        image-set(var(--bg-1x) 1x, var(--bg-2x) 2x),
        linear-gradient(var(--base-top), var(--base-bot));
      background-repeat: no-repeat, no-repeat, no-repeat;
      background-size: auto, cover, auto;
      background-attachment: fixed, fixed, fixed;
      background-position:
        center center,
        calc(50% + var(--bg-x)) calc(0% + var(--bg-y)),
        center center;

      overflow-x:hidden;
    }

    main{ flex:1 }

    /* ===================== NAV ===================== */
    .site-nav{ position:sticky; top:0; z-index:1000; padding:20px 0 }
    .nav{
      display:flex; gap:var(--nav-gap);
      padding-left:var(--edge); padding-right:var(--edge);
      align-items:center;
    }
    .nav a{
      padding:var(--nav-py) var(--nav-px); border-radius:12px; text-decoration:none;
      background:var(--nav-bg); border:1px solid var(--nav-b); color:#fff
    }
    .nav a:hover{ background:var(--nav-hover) }
    /* Nav CTA – “Køb MCD” */
    .nav .cta{
      margin-left:auto;
      background:linear-gradient(135deg,#FFD700,#DAA520);
      color:#1c2630; border-color:#865c10; font-weight:800;
    }
    .nav .cta:hover{ filter:brightness(1.06) }

    /* ===================== SOCIALE LINKS ===================== */
    .social-menu{ position:fixed; top:var(--social-top); left:var(--edge); display:flex; flex-direction:column; gap:10px; z-index:999 }
    .social-menu a{ width:42px; height:42px; display:grid; place-items:center; background:rgba(0,0,0,.7); border-radius:8px; text-decoration:none }
    .social-menu a img{ width:22px; height:22px }

    /* ===================== SCENE ===================== */
    .stage{
      position:relative;
      max-width:var(--container);
      margin:18px auto 26px;
      padding:0 16px;
    }

    /* Venstre kolonne */
    .left-rail-box{
      position:absolute; top:var(--left-rail-top); left:var(--left-rail-left);
      width:var(--left-col); z-index:3;
    }

    .hero{
      background:#0b0b0c; border:1px solid #2a2a2a; border-radius:16px;
      box-shadow:0 12px 26px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.06);
      padding:16px 18px;
    }
    .hero .ribbon{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; background:#102414; border:1px solid #1d3d22; color:#baf7c9; margin-bottom:6px }
    .hero h1{ font-size:clamp(22px,2.6vw,26px); margin:0 0 .5rem }
    .hero .sub{ color:#cfd3d7; margin:.25rem 0 .5rem }
    .hero .points{ display:flex; flex-wrap:wrap; gap:6px 8px; margin:.5rem 0 .75rem }
    .hero .pt{ padding:6px 10px; border-radius:999px; background:#0d0d0f; border:1px solid #333; font-size:.9rem }
    .hero .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px }
    .hero .btn{ padding:9px 14px; border-radius:12px; text-decoration:none; background:#0d0d0f; border:1px solid #333; color:#fff }
    .hero .btn.primary{ background:linear-gradient(135deg,#FFD700,#DAA520); color:#1c2630 }

    /* (NYT) Brand-logo under Hero */
    .brand-hero{
      margin-top:12px;
      background:#0b0b0c; border:1px solid #2a2a2a; border-radius:16px;
      box-shadow:0 12px 26px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.06);
      padding:14px 16px; display:flex; align-items:center; justify-content:center;
    }
    .brand-hero img{
      display:block; width:min(420px, 92%); height:auto; object-fit:contain;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.45));
    }

    /* Højre kolonne (mønter+YouTube) */
    .right-rail{ margin-left: var(--right-rail-left); position:relative; z-index:3 }
    .right-stack{ display:inline-block; vertical-align:top }

    .coins{ display:inline-flex; flex-wrap:nowrap; gap:24px; align-items:flex-start; width:520px; justify-content:center }
    .coin{
      background:#fff8dc; padding:10px; border-radius:15px; width:240px;
      text-align:center; box-shadow:0 0 12px rgba(0,0,0,.1); border:2px solid #e5c100
    }
    .coin img{ width:200px; height:200px; border-radius:10px; margin-bottom:8px; object-fit:cover }
    .coin-description{ font-size:.9rem; color:#333; margin:0 0 8px }
    .button{ background:linear-gradient(135deg,#FFD700,#DAA520); color:#004d73!important; padding:9px 14px; border:none; border-radius:6px; font-weight:700; cursor:pointer }
    .button:hover{ background:linear-gradient(135deg,#FFC107,#B8860B) }

    .yt-wrap{ width:520px; margin:22px 0 0 0 }
    #yt-player{ position:relative; padding-top:56.25%; border:2px solid #222; border-radius:14px; overflow:hidden; background:#000 }
    #yt-thumbs{ display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:12px; margin-top:12px }

    footer{ margin-top:auto; text-align:center; padding:16px; background:#e4e6c5; color:#000 }

    /* Responsiv */
    @media (max-width:1150px){
      .left-rail-box{ position:static; width:auto }
      .right-rail{ margin-left:0 }
      .right-stack{ display:block }
      .coins{ width:100%; justify-content:center; gap:16px; flex-wrap:wrap }
      .yt-wrap{ width:100% }
      .stage{ padding:0 16px }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="site-nav">
    <nav class="nav">
      <a href="/" data-text="common:nav_home">Home</a>
      <a href="/about" data-text="common:nav_about">About</a>
      <a href="/roadmap" data-text="common:nav_roadmap">Roadmap</a>
      <a href="/reports" data-text="common:nav_reports">Reports</a>
      <a href="#" id="nav-buy" class="cta">Køb MCD</a>
    </nav>
  </header>

  <main>
    <!-- Sociale links -->
    <div class="social-menu" id="social-menu"></div>

    <!-- Scene -->
    <section class="stage">
      <!-- Venstre kolonne -->
      <div class="left-rail-box">
        <section class="hero" id="home-hero">
          <div class="ribbon">NYHED: 25% hotelrabat til MCD-holders</div>
          <h1>Donér. Byg. Forandr Madagaskar.</h1>
          <p class="sub">MadaCoin Donation (MCD) finansierer skoler, solenergi og lokale jobs — med fuld gennemsigtighed.</p>
          <div class="points">
            <span class="pt">Skolebyggeri</span>
            <span class="pt">Solceller &amp; batterier</span>
            <span class="pt">Åbne rapporter</span>
          </div>
          <div class="btns">
            <button class="btn primary" id="hero-primary">Støt med MadaCoin</button>
            <a class="btn" href="/reports">Se rapporter</a>
          </div>
        </section>

        <!-- (NYT) Brand-logo under Hero -->
        <section class="brand-hero" aria-label="MCD logo">
          <img id="brand-hero-img" alt="MCD logo" />
        </section>
      </div>

      <!-- Højre kolonne -->
      <div class="right-rail">
        <div class="right-stack">
          <section class="coins">
            <div class="coin">
              <img id="coinD" alt="MadaCoin Donation" />
              <p class="coin-description">Støt vores mission ved at købe MadaCoin Donation.</p>
              <button class="button" id="buy-mcd">Køb MadaCoin Donation</button>
            </div>
          </section>

          <section id="yt-section" class="yt-wrap">
            <div id="yt-player"></div>
            <div id="yt-thumbs"></div>
          </section>
        </div>
      </div>
    </section>
  </main>

  <footer>© 2025 MadaCoin. All rights reserved.</footer>

  <script>
    /* ===== Supabase setup ===== */
    const SUPABASE_URL="https://byrlebjwknppjbtbkozt.supabase.co";
    const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cmxlYmp3a25wcGpidGJrb3p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjcyNjYsImV4cCI6MjA2NzM0MzI2Nn0.3aoQMQgmxXouUfpqrwfSgcUgedjZEue6s3ZkGoqvQYY";
    const sb = window.supabase ? window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON) : null;

    /* ===== Baggrund via site_settings (samme som About) ===== */
    async function applyBackgroundForPage(pageKey='home'){
      if(!sb) return;
      try{
        const keys=[`bg_${pageKey}_1x`,`bg_${pageKey}_2x`,`bg_default_1x`,`bg_default_2x`];
        const { data } = await sb.from('site_settings').select('key,value').in('key', keys);
        const map = Object.fromEntries((data||[]).map(r=>[r.key,r.value]));
        const one = map[`bg_${pageKey}_1x`] || map['bg_default_1x'] || '';
        const two = map[`bg_${pageKey}_2x`] || map['bg_default_2x'] || '';
        if(one) document.body.style.setProperty('--bg-1x', `url("${one}")`);
        if(two) document.body.style.setProperty('--bg-2x', `url("${two}")`);
      }catch(e){ console.warn('[home] background', e); }
    }

    /* ===== On-ramp (Ramp) ===== */
    const DEFAULT_MCD_WALLET = "0xa594586B04f1b6782EC906B49882EbD0E652a388";
    async function openRampMCD(){
      const wallet = DEFAULT_MCD_WALLET;
      window.open("https://ramp.network/buy?swapAsset=USDT&userAddress="+encodeURIComponent(wallet), "_blank");
    }

    /* Tekster & sociale links */
    async function loadSiteText(){
      if(!sb) return {};
      try{
        const { data } = await sb.from('site_text').select('page,key,value,content,project,is_active')
          .in('page',['common','home']).eq('project','MCD').eq('is_active',true);
        const dict={};
        (data||[]).forEach(r=>{
          const v = (r.value ?? r.content ?? '').toString();
          if(v) dict[`${r.page}:${r.key}`]=v;
        });
        document.querySelectorAll('[data-text]').forEach(el=>{
          const k=el.getAttribute('data-text'); if(dict[k]!=null) el.innerHTML=dict[k];
        });
        return dict;
      }catch{ return {}; }
    }
    function normalizeUrl(u){ if(!u) return null; const t=u.trim(); return /^https?:\/\//i.test(t)?t:'https://'+t }
    function iconUrlFor(p){ if(!sb) return null; const name=p.charAt(0).toUpperCase()+p.slice(1).toLowerCase(); const {data}=sb.storage.from('social.icons').getPublicUrl(`${name}.svg`); return data?.publicUrl||null }
    function fallbackIconUrl(){ if(!sb) return ''; const {data}=sb.storage.from('social.icons').getPublicUrl('Globe.svg'); return data?.publicUrl||'' }
    async function renderSocialLinks(){
      const el=document.getElementById('social-menu'); if(!el||!sb) return;
      el.innerHTML='';
      const {data}=await sb.from('social_links').select('platform,url,is_active,sort_order')
        .eq('is_active',true).order('sort_order',{ascending:true});
      const globe=fallbackIconUrl();
      (data||[]).filter(r=>r.url&&r.url.trim()!=='').forEach(r=>{
        const a=document.createElement('a'); const href=normalizeUrl(r.url); if(!href) return;
        a.href=href; a.target='_blank'; a.rel='noopener noreferrer'; a.title=r.platform; a.setAttribute('aria-label',r.platform);
        const img=document.createElement('img'); img.src=iconUrlFor(r.platform)||globe; img.onerror=()=>{img.src=globe}; a.appendChild(img); el.appendChild(a);
      });
    }

    /* Billeder (mønt) */
    const storeBase = `${SUPABASE_URL}/storage/v1/object/public`;
    const pub = (...p)=>`${storeBase}/${p.map(encodeURIComponent).join('/')}`;
    function setCoinImages(){
      const d=document.getElementById('coinD');
      if(d) d.src=pub('images','MadaCoin_D.png');
    }

    /* ===== (NYT) Branding fra bucket 'logo' – hero-logo + favicon ===== */
    const LOGO_BUCKET = 'logo';
    const BRAND_EXTS  = ['svg','png','webp','jpg','jpeg'];
    const FAV_EXTS    = ['svg','png','ico'];

    function setPlaceholderLogo(){
      const img=document.getElementById('brand-hero-img'); if(!img) return;
      img.src=`data:image/svg+xml;utf8,` +
        encodeURIComponent(`
          <svg xmlns='http://www.w3.org/2000/svg' width='800' height='220'>
            <rect width='100%' height='100%' rx='18' fill='#0d0f12'/>
            <text x='50%' y='54%' text-anchor='middle' font-family='Segoe UI, Arial' font-size='84' font-weight='900' fill='#FFD700'>MCD</text>
            <text x='50%' y='82%' text-anchor='middle' font-family='Segoe UI, Arial' font-size='24' fill='#d6d6d6'>Logo placeholder</text>
          </svg>
        `);
    }
    function publicUrl(bucket, path){
      const { data } = sb.storage.from(bucket).getPublicUrl(path);
      return data?.publicUrl || null;
    }
    function probeImage(url, timeoutMs=6000){
      return new Promise((resolve)=>{
        if(!url) return resolve(null);
        const img = new Image(); let done=false;
        const finish = ok => { if(!done){ done=true; resolve(ok ? url : null); } };
        const t = setTimeout(()=>finish(false), timeoutMs);
        img.onload = ()=>{ clearTimeout(t); finish(true); };
        img.onerror = ()=>{ clearTimeout(t); finish(false); };
        const cb = Math.floor(Date.now() / (12*60*60*1000));
        img.src = url + (url.includes('?') ? `&cb=${cb}` : `?cb=${cb}`);
      });
    }
    async function firstExisting(baseName, exts){
      for(const ext of exts){
        const u = publicUrl(LOGO_BUCKET, `${baseName}.${ext}`);
        if(await probeImage(u)) return u;
      }
      return null;
    }
    async function applyBrandingFromBucket(project='MCD'){
      setPlaceholderLogo();
      if(!sb) return;
      const base = (project||'MCD').toUpperCase();

      // Hero-logo
      const hero = await firstExisting(base, BRAND_EXTS);
      const heroEl = document.getElementById('brand-hero-img');
      if(heroEl && hero) heroEl.src = hero;

      // Favicon (særskilt fil → ellers logo)
      const fav = await firstExisting(`${base}-favicon`, FAV_EXTS) || hero;
      const favEl = document.getElementById('favicon');
      if(favEl && fav) favEl.href = fav;
    }

    /* YouTube */
    function getYouTubeId(url){ if(!url) return null; try{ const u=new URL(url); if(u.hostname.includes('youtu.be')) return u.pathname.slice(1); if(u.searchParams.get('v')) return u.searchParams.get('v'); const m=url.match(/(?:embed|shorts)\/([a-zA-Z0-9_-]{6,})/); if(m) return m[1]; const seg=u.pathname.split('/').pop(); return seg&&seg.length>=6?seg:null }catch{return null} }
    function thumbUrl(id){ return `https://i.ytimg.com/vi/${id}/hqdefault.jpg` }
    function renderPlayer(id){
      const el=document.getElementById('yt-player');
      el.innerHTML=`<iframe src="https://www.youtube.com/embed/${id}" title="MadaCoin video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;"></iframe>`;
    }
    function renderThumbs(videos,active){
      const wrap=document.getElementById('yt-thumbs'); wrap.innerHTML='';
      videos.forEach(v=>{
        const id=v._id;
        const btn=document.createElement('button');
        btn.style.background='transparent';
        btn.style.border=id===active?'3px solid #f0b90b':'2px solid #333';
        btn.style.borderRadius='12px';
        btn.style.overflow='hidden';
        btn.style.cursor='pointer';
        btn.style.padding='0';
        btn.title=v.title||'Se video';
        btn.innerHTML=`<img src='${thumbUrl(id)}' alt='${v.title||"YouTube thumbnail"}' style="display:block;width:100%;height:100%;object-fit:cover;">`;
        btn.onclick=()=>{ renderPlayer(id); [...wrap.children].forEach(c=>c.style.border='2px solid #333'); btn.style.border='3px solid #f0b90b'; };
        wrap.appendChild(btn);
      });
    }
    async function initYouTube(){
      if(!sb){ document.getElementById('yt-section').style.display='none'; return; }
      const {data,error}=await sb.from('youtube_videos')
        .select('youtube_url,is_active,created_at,title,sort_order')
        .eq('is_active',true).not('youtube_url','is',null).neq('youtube_url','')
        .order('sort_order',{ascending:true,nullsFirst:false}).order('created_at',{ascending:false});
      if(error) return;
      const vids=(data||[]).map(v=>({...v,_id:getYouTubeId(v.youtube_url)})).filter(v=>v._id);
      if(!vids.length){ document.getElementById('yt-section').style.display='none'; return; }
      document.getElementById('yt-section').style.display='';
      renderPlayer(vids[0]._id); renderThumbs(vids,vids[0]._id);
    }

    /* Knap-handlers */
    function attachHeroActions(){
      const btn1=document.getElementById('hero-primary');
      const btn2=document.getElementById('buy-mcd');
      const navBuy=document.getElementById('nav-buy');
      if(btn1) btn1.addEventListener('click',openRampMCD);
      if(btn2) btn2.addEventListener('click',openRampMCD);
      if(navBuy){ navBuy.addEventListener('click', (e)=>{ e.preventDefault(); openRampMCD(); }); }
    }

    /* Init */
    window.addEventListener('load', async ()=>{
      await applyBackgroundForPage('home');  // baggrund (samme som About)
      await loadSiteText();
      await renderSocialLinks();
      setCoinImages();
      await applyBrandingFromBucket('MCD');  // (NYT) hero-logo + favicon fra bucket 'logo'
      initYouTube();
      attachHeroActions();
    });
  </script>
</body>
</html>
