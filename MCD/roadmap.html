<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MadaCoin – Roadmap</title>
  <link id="favicon" rel="icon" href="/favicon_boosted.ico?v=1" type="image/x-icon">
  <link rel="preconnect" href="https://unpkg.com" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    *,*::before,*::after{ box-sizing:border-box }
    html{ font-size:16px }

    :root{
      --edge-pad:24px; --nav-gap:14px; --nav-pad-x:14px; --nav-pad-y:8px;
      --nav-text:#fff; --nav-bg:#0d0d0f; --nav-border:#333;
      --nav-hover-bg:#151517; --nav-hover-border:#444; --nav-active:#5aa9ff;
      --bg:#061a2b;
      --bg-image:url('https://byrlebjwknppjbtbkozt.supabase.co/storage/v1/object/public/backgrounds/ocean.png');
      --bg-1x: var(--bg-image);
      --bg-2x: var(--bg-image);
    }

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      font-size:1rem; line-height:1.5; margin:0; color:#fff;
      min-height:100svh; display:flex; flex-direction:column;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.14)),
        image-set(var(--bg-1x) 1x, var(--bg-2x) 2x),
        var(--bg);
      background-repeat:no-repeat,no-repeat,no-repeat;
      background-size:auto,cover,auto;
      background-attachment:fixed,fixed,fixed;
      background-position:center center, center top, center center;
    }
    @media (max-width:800px){ body{ background-attachment:scroll,scroll,scroll } }

    .site-nav{ position:sticky; top:0; z-index:9999; padding:12px 0; background:transparent }
    .site-nav .nav-inner{ padding-left:var(--edge-pad); padding-right:var(--edge-pad) }
    .nav{ display:flex; gap:var(--nav-gap); align-items:center; flex-wrap:wrap; justify-content:flex-start; transform:translateY(-2px) }
    .nav a{
      display:inline-flex; align-items:center; justify-content:center;
      padding:var(--nav-pad-y) var(--nav-pad-x);
      color:var(--nav-text); background:var(--nav-bg); border:1px solid var(--nav-border);
      border-radius:12px; text-decoration:none; opacity:.96; box-shadow:inset 0 1px 0 rgba(255,255,255,.06)
    }
    .nav a:hover{ background:var(--nav-hover-bg); border-color:var(--nav-hover-border) }
    .nav a[aria-current="page"]{
      border-color:var(--nav-active);
      box-shadow:0 0 0 2px rgba(90,169,255,.25) inset;
    }

    .social-menu{ position:fixed; top:110px; left:16px; display:flex; flex-direction:column; gap:10px; z-index:1000 }
    .social-menu a{
      display:flex; align-items:center; justify-content:center;
      width:42px; height:42px; background:rgba(0,0,0,.7);
      border:1px solid #2a2f36; border-radius:8px;
      text-decoration:none; transition:background .15s, transform .15s;
    }
    .social-menu a:hover{ background:rgba(0,0,0,.85); transform:translateY(-2px) }
    .social-menu a img{ width:22px; height:22px }

    .wrap{ flex:1; display:flex; align-items:center; justify-content:center; padding:12px 24px 24px; }

    .roadmap{
      margin:0 auto;
      max-width:1440px;
      padding:0 20px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:24px;
      align-items:start;
    }
    .roadmap-box{
      background:rgba(255,248,220,.95);
      padding:18px 24px;
      border-radius:20px;
      border:2px solid #e5c100;
      box-shadow:0 0 12px rgba(0,0,0,.1);
      display:flex; flex-direction:column; gap:10px;
      width:100%; max-width:none;
    }
    .roadmap-box h2{ margin:0; color:#444; font-size:1.2rem }
    .description{ font-size:.8rem; margin:0; color:#555 }
    .step-images{ display:flex; flex-wrap:wrap; gap:10px; max-width:100%; justify-content:flex-start; margin-top:22px }
    .step-images img{ width:80px; height:80px; object-fit:cover; cursor:pointer; margin:5px; transition:transform .3s }
    .roadmap-thumb{ cursor:zoom-in }

    footer{ text-align:center; padding:16px 20px; background:#e4e6c5; color:#000; margin-top:auto }

    #rm-lightbox{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:100000 }
    #rm-lightbox.active{ display:flex }
    #rm-lightbox .rm-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.85) }
    body.modal-open{ overflow:hidden; height:100vh }
    #rm-image{
      -webkit-touch-callout:none; position:relative; max-width:100vw; max-height:100vh;
      transform-origin:center; touch-action:none; user-select:none; -webkit-user-drag:none; cursor:zoom-out
    }

    @media (min-width:901px){
      .roadmap-box:nth-child(1){ grid-column:1; grid-row:1; }
      .roadmap-box:nth-child(2){ grid-column:2; grid-row:1; }
      .roadmap-box:nth-child(3){ grid-column:1; grid-row:2; }
      .roadmap-box:nth-child(4){ grid-column:2; grid-row:2; }
    }

    @media (max-width:900px){
      .roadmap{ grid-template-columns:1fr; max-width:820px; }
      .roadmap-box{ padding:14px 16px }
      .step-images img{ width:72px; height:72px }
    }
  </style>
</head>
<body>
  <header class="site-nav">
    <div class="nav-inner">
      <nav class="nav">
        <a href="/" data-text="common:nav_home">Home</a>
        <a href="/about" data-text="common:nav_about">About</a>
        <a href="/roadmap" data-text="common:nav_roadmap">Roadmap</a>
        <a href="/reports" data-text="common:nav_reports">Reports</a>
      </nav>
    </div>
  </header>

  <div class="social-menu" id="social-menu" aria-label="Sociale medier"></div>

  <main class="wrap">
    <section class="roadmap" id="roadmap"></section>
  </main>

  <div id="rm-lightbox" aria-hidden="true">
    <div class="rm-backdrop"></div>
    <img id="rm-image" alt="Roadmap" />
  </div>

  <footer><span id="footer-text" data-text="common:footer">© 2025 MadaCoin. All rights reserved.</span></footer>

  <script>
    const SUPABASE_URL="https://byrlebjwknppjbtbkozt.supabase.co";
    const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cmxlYmp3a25wcGpidGJrb3p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjcyNjYsImV4cCI6MjA2NzM0MzI2Nn0.3aoQMQgmxXouUfpqrwfSgcUgedjZEue6s3ZkGoqvQYY";
    const sb = window.supabase ? window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON) : null;

    (function markActive(){
      try{
        const here = location.pathname.replace(/\/index\.html?$/,'/');
        document.querySelectorAll('header .nav a').forEach(a=>{
          const to = a.getAttribute('href');
          if (to === here || (here === '/' && to === '/')) a.setAttribute('aria-current','page');
          else a.removeAttribute('aria-current');
        });
      }catch(e){}
    })();

    async function applyBackgroundForPage(pageKey='roadmap'){
      if(!sb) return;
      try{
        const keys=[`bg_${pageKey}_1x`,`bg_${pageKey}_2x`,`bg_default_1x`,`bg_default_2x`];
        const { data } = await sb.from('site_settings').select('key,value').in('key', keys);
        const map = Object.fromEntries((data||[]).map(r=>[r.key,r.value]));
        const one = map[`bg_${pageKey}_1x`] || map['bg_default_1x'] || '';
        const two = map[`bg_${pageKey}_2x`] || map['bg_default_2x'] || '';
        if(one) document.body.style.setProperty('--bg-1x', `url("${one}")`);
        if(two) document.body.style.setProperty('--bg-2x', `url("${two}")`);
      }catch(e){ console.warn('[roadmap] background', e); }
    }

    const LOGO_BUCKET='logo';
    const BRAND_EXTS=['svg','png','webp','jpg','jpeg'];
    const FAV_EXTS=['svg','png','ico'];
    function publicUrl(bucket,path){ const {data}=sb.storage.from(bucket).getPublicUrl(path); return data?.publicUrl||null }
    function probeImage(url,timeoutMs=6000){
      return new Promise((resolve)=>{
        if(!url) return resolve(null);
        const img=new Image(); let done=false;
        const finish=ok=>{ if(!done){ done=true; resolve(ok?url:null); } };
        const t=setTimeout(()=>finish(false),timeoutMs);
        img.onload=()=>{ clearTimeout(t); finish(true); };
        img.onerror=()=>{ clearTimeout(t); finish(false); };
        const cb=Math.floor(Date.now()/(12*60*60*1000));
        img.src=url+(url.includes('?')?`&cb=${cb}`:`?cb=${cb}`);
      });
    }
    async function firstExisting(baseName,exts){
      for(const ext of exts){
        const u=publicUrl(LOGO_BUCKET,`${baseName}.${ext}`);
        if(await probeImage(u)) return u;
      }
      return null;
    }
    async function applyBrandingFromBucket(project='MCD'){
      if(!sb) return;
      const base=(project||'MCD').toUpperCase();
      const fav = await firstExisting(`${base}-favicon`,FAV_EXTS) || await firstExisting(base,BRAND_EXTS);
      const favEl=document.getElementById('favicon'); if(favEl && fav) favEl.href=fav;
    }

    async function loadSiteText(){
      if(!sb) return {};
      try{
        const { data } = await sb.from('site_text').select('page,key,value,content,project,is_active')
          .in('page',['common']).eq('is_active',true);
        const dict={}; (data||[]).forEach(r=>{
          const v=(r.value ?? r.content ?? '').toString();
          if(v) dict[`${r.page}:${r.key}`]=v;
        });
        document.querySelectorAll('[data-text]').forEach(el=>{
          const k=el.getAttribute('data-text'); if(dict[k]!=null) el.innerHTML=dict[k];
        });
        return dict;
      }catch(e){ console.warn('[roadmap] site_text',e); return {}; }
    }

    function normalizeUrl(u){ if(!u) return null; const t=u.trim(); return /^https?:\/\//i.test(t)?t:'https://'+t }
    function iconUrlFor(p){ if(!sb) return null; const name=p.charAt(0).toUpperCase()+p.slice(1).toLowerCase(); const {data}=sb.storage.from('social.icons').getPublicUrl(`${name}.svg`); return data?.publicUrl||null }
    function fallbackIconUrl(){ if(!sb) return ''; const {data}=sb.storage.from('social.icons').getPublicUrl('Globe.svg'); return data?.publicUrl||'' }
    async function renderSocialLinks(){
      const el=document.getElementById('social-menu'); if(!el||!sb) return;
      el.innerHTML='';
      const {data}=await sb.from('social_links').select('platform,url,is_active,sort_order')
        .eq('is_active',true).order('sort_order',{ascending:true});
      const globe=fallbackIconUrl();
      (data||[]).filter(r=>r.url&&r.url.trim()!=='').forEach(r=>{
        const a=document.createElement('a'); const href=normalizeUrl(r.url); if(!href) return;
        a.href=href; a.target='_blank'; a.rel='noopener noreferrer'; a.title=r.platform; a.setAttribute('aria-label',r.platform);
        const img=document.createElement('img'); img.src=iconUrlFor(r.platform)||globe; img.onerror=()=>{img.src=globe}; a.appendChild(img); el.appendChild(a);
      });
    }

    const base="https://byrlebjwknppjbtbkozt.supabase.co/storage/v1/object/public";
    const buckets=["roadmap1","roadmap2","roadmap3","roadmap4"];
    const steps=[
      {title:"Køb byggegrund - Opret projekt kontor",desc:"Når målet er opfyldt, køber vi byggegrund og opretter projektkontor."},
      {title:"De første boliger bygges",desc:"Når minimum målet er opfyldt, sættes projektet i gang."},
      {title:"Solcellepark og batterier",desc:"Når målet er opnået, installerer vi solceller og batterier."},
      {title:"Byg en Skole",desc:"Byggeprojekt fra børnehave til gymnasium."}
    ];

    function renderRoadmap(){
      const root=document.getElementById('roadmap'); root.innerHTML='';
      buckets.forEach((bucket,idx)=>{
        const i=idx+1, s=steps[idx]||{title:`Roadmap ${i}`,desc:''};
        const box=document.createElement('div'); box.className='roadmap-box';
        box.innerHTML=`<h2>${s.title}</h2><p class="description">${s.desc}</p><div class="step-images" id="imgs-${i}"></div>`;
        root.appendChild(box);
        const wrap=document.getElementById(`imgs-${i}`);
        for(let k=1;k<=10;k++){
          const url=`${base}/${bucket}/Roadmap_${i}_pic_${k}.png`;
          const img=document.createElement('img');
          img.alt=`Roadmap ${i} billede ${k}`;
          img.src=url;
          img.classList.add('roadmap-thumb');
          img.loading='lazy';
          img.decoding='async';
          img.onerror=()=>img.remove();
          if(!img.dataset.lbBound){
            img.dataset.lbBound="1";
            img.addEventListener('click',(e)=>{
              e.preventDefault();
              const full=img.dataset.fullsrc||img.src;
              if(typeof openLightbox==='function') openLightbox(full);
            },{passive:false});
          }
          wrap.appendChild(img);
        }
        setTimeout(()=>{ if(!wrap.querySelector('img')) wrap.innerHTML=`<p style="color:#222;margin:6px 0;background:rgba(255,247,214,.95);padding:6px 8px;border-radius:8px;">Billeder kommer snart…</p>`; },500);
      });
    }

    let rmBox, rmImg, scale=1, tx=0, ty=0; const MIN_SCALE=1, MAX_SCALE=4;
    function applyTransform(){ if(!rmImg) return; rmImg.style.transform=`translate(${tx}px, ${ty}px) scale(${scale})` }
    function centerReset(){ scale=1; tx=0; ty=0; applyTransform() }
    function openLightbox(src){ rmImg.src=src; centerReset(); document.body.classList.add('modal-open'); rmBox.classList.add('active'); rmBox.setAttribute('aria-hidden','false') }
    function closeLightbox(){ document.body.classList.remove('modal-open'); rmBox.classList.remove('active'); rmBox.setAttribute('aria-hidden','true'); rmImg.src='' }
    function rmWheelHandler(e){ e.preventDefault(); const r=rmImg.getBoundingClientRect(); const cx=e.clientX-(r.left+r.width/2)-tx, cy=e.clientY-(r.top+r.height/2)-ty; const old=scale; const factor=Math.exp(-e.deltaY*0.0015); scale=Math.max(MIN_SCALE,Math.min(MAX_SCALE,scale*factor)); const k=scale/old; tx-=cx*(k-1); ty-=cy*(k-1); applyTransform() }
    let touchMoved=false,pinchStartDist=0,pinchStartScale=1,panStartX=0,panStartY=0,panning=false;
    function rmTouchStart(e){ touchMoved=false; if(e.touches.length===2){ const[a,b]=e.touches; pinchStartDist=Math.hypot(b.clientX-a.clientX,b.clientY-a.clientY); pinchStartScale=scale; } else if(e.touches.length===1 && scale>1){ const t=e.touches[0]; panning=true; panStartX=t.clientX-tx; panStartY=t.clientY-ty; } }
    function rmTouchMove(e){ if(e.touches.length===2){ e.preventDefault(); const[a,b]=e.touches; const d=Math.hypot(b.clientX-a.clientX,b.clientY-a.clientY); scale=Math.max(MIN_SCALE,Math.min(MAX_SCALE,pinchStartScale*(d/pinchStartDist))); applyTransform(); touchMoved=true; } else if(e.touches.length===1 && panning){ e.preventDefault(); const t=e.touches[0]; tx=t.clientX-panStartX; ty=t.clientY-panStartY; applyTransform(); touchMoved=true; } }
    function rmTouchEnd(){ panning=false; if(!touchMoved){ if(scale>1) centerReset(); else closeLightbox(); } }

    function equalizeRoadmapHeights(){
      const mq = window.matchMedia('(min-width:901px)');
      const boxes = Array.from(document.querySelectorAll('.roadmap-box'));
      boxes.forEach(b => b.style.minHeight = '');
      if(!mq.matches) return;
      let max = 0;
      boxes.forEach(b => { max = Math.max(max, b.offsetHeight); });
      boxes.forEach(b => { b.style.minHeight = max + 'px'; });
    }

    function openLightbox(src){ rmImg.src=src; centerReset(); document.body.classList.add('modal-open'); rmBox.classList.add('active'); rmBox.setAttribute('aria-hidden','false') }

    window.addEventListener('load', async ()=>{
      rmBox=document.getElementById('rm-lightbox'); rmImg=document.getElementById('rm-image');
      if(rmBox&&rmImg){
        rmBox.addEventListener('click',(e)=>{ const backdrop=e.target===rmBox||e.target.classList.contains('rm-backdrop'); const img=e.target===rmImg; if(backdrop||img) closeLightbox(); },{passive:true});
        rmImg.addEventListener('wheel',rmWheelHandler,{passive:false});
        rmImg.addEventListener('click',()=>{ if(scale>1) centerReset(); else closeLightbox(); });
        rmImg.addEventListener('touchstart',rmTouchStart,{passive:true});
        rmImg.addEventListener('touchmove',rmTouchMove,{passive:false});
        rmImg.addEventListener('touchend',rmTouchEnd,{passive:true});
        rmImg.addEventListener('contextmenu',(e)=>e.preventDefault());
        window.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && rmBox.classList.contains('active')) closeLightbox(); });
      }

      await applyBackgroundForPage('roadmap');
      await loadSiteText();
      await applyBrandingFromBucket('MCD');
      await renderSocialLinks();
      renderRoadmap();

      equalizeRoadmapHeights();
      const imgs = document.querySelectorAll('.step-images img');
      imgs.forEach(im=>{ im.addEventListener('load', equalizeRoadmapHeights); im.addEventListener('error', equalizeRoadmapHeights); });
      window.addEventListener('resize', equalizeRoadmapHeights);
      setTimeout(equalizeRoadmapHeights, 400);
      setTimeout(equalizeRoadmapHeights, 1200);
    });
  </script>
</body>
</html>
