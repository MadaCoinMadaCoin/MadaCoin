<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MadaCoin · Admin</title>
<link rel="preconnect" href="https://unpkg.com" />
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  :root{
    --edge:20px;
    --bg:#0a1220;
    --card:#0f172a; --card-b:#21324d; --soft:#0b1324;
    --text:#eaf2ff; --muted:#b9c6dd; --acc:#8bd5ff; --warn:#ffb8b8; --ok:#68e39b;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.10)), var(--bg);
    color:var(--text);
  }
  a{ color:var(--acc); text-decoration:none }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px var(--edge) 32px }

  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:12px var(--edge);
    position:sticky; top:0; z-index:5;
    background:rgba(7,12,24,.85); backdrop-filter: blur(6px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .brand{ display:flex; align-items:center; gap:10px; }
  .brand img{ width:32px; height:32px; }
  .brand .t{ font-weight:700; letter-spacing:.3px }
  .user{ font-size:13px; color:var(--muted) }
  .signout{ border:1px solid #34557c; border-radius:10px; padding:8px 12px; background:#0e1a2f; color:#eaf2ff; cursor:pointer }

  .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin:18px 0 }
  .tabs button{
    border:1px solid #2a3e5d; background:#0d172b; color:#eaf2ff; padding:10px 14px; border-radius:999px; cursor:pointer;
  }
  .tabs button.active{ border-color:#5aa9ff; box-shadow:0 0 0 2px rgba(90,169,255,.25) inset; }

  .grid{ display:grid; gap:16px }
  @media(min-width:900px){ .cols-2{ grid-template-columns:1fr 1fr } .cols-3{ grid-template-columns:1fr 1fr 1fr } }

  .card{
    background:var(--card); border:1px solid var(--card-b); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px;
  }
  .card h3{ margin:4px 0 12px }
  .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  .field{ display:flex; flex-direction:column; gap:6px; min-width:220px }
  label{ font-size:13px; color:#cfe3ff }
  input, select, textarea{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3e5d; background:#0a1427; color:#fff;
  }
  textarea{ min-height:120px; resize:vertical }
  .btn{ cursor:pointer; border:1px solid #2c4e74; border-radius:10px; padding:10px 12px; background:#0f1c33; color:#fff }
  .btn.primary{ background:linear-gradient(135deg,#8bd5ff,#66c2ff); color:#0b2236; border-color:#27608a; font-weight:700 }
  .btn.warn{ background:#3a1010; border-color:#7a2a2a }
  .hint{ font-size:12px; color:var(--muted) }
  .ok{ color:var(--ok) } .err{ color:#ff9aa3 }
  .sep{ height:1px; background:rgba(255,255,255,.08); margin:12px 0 }

  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left; vertical-align:top; }
  th{ color:#cfe3ff; font-weight:600 }

  .hidden{ display:none !important }
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <img src="/img/madacoin_logo.svg" alt="MC">
      <div class="t">MadaCoin · Admin</div>
    </div>
    <div class="row">
      <div class="user" id="who"></div>
      <button class="signout" id="btn-signout">Log ud</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <button data-tab="dash" class="active">Overblik</button>
      <button data-tab="bg">Baggrunde</button>
      <button data-tab="social">Sociale links</button>
      <button data-tab="text">Tekster</button>
      <button data-tab="yt">YouTube</button>
      <button data-tab="team">Team</button>
      <button data-tab="partners">Partnere</button>
    </div>

    <!-- DASHBOARD -->
    <section id="tab-dash" class="card">
      <h3>Velkommen</h3>
      <div class="grid cols-3">
        <div class="card">
          <h4>Hurtige genveje</h4>
          <div class="row">
            <a class="btn" href="/index.html" target="_blank">Forside</a>
            <a class="btn" href="/madacoin.html" target="_blank">Om</a>
            <a class="btn" href="/roadmap.html" target="_blank">Roadmap</a>
            <a class="btn" href="/rapporter.html" target="_blank">Rapporter</a>
          </div>
          <div class="hint" style="margin-top:10px">Alle tekster/baggrunde/links styres her fra panelet.</div>
        </div>
        <div class="card">
          <h4>Status</h4>
          <div id="status-box" class="hint">Indlæser…</div>
        </div>
        <div class="card">
          <h4>Tips</h4>
          <ul class="hint" style="margin:0 0 0 16px">
            <li>Upload 1× ≈ 2048px og 2× ≈ 4096px for skarpe baggrunde.</li>
            <li>Ikon-navne i <code>social.icons</code> skal starte med stort bogstav (fx <code>Twitter.svg</code>).</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- BAGGRUNDE -->
    <section id="tab-bg" class="card hidden">
      <h3>Baggrunde pr. side</h3>
      <div class="grid cols-2">
        <div class="card">
          <div class="row">
            <div class="field">
              <label>Arbejdsside</label>
              <select id="bg-work">
                <option value="home">home</option>
                <option value="om">om</option>
                <option value="roadmap">roadmap</option>
                <option value="rapporter">rapporter</option>
                <option value="default">default (fallback)</option>
              </select>
            </div>
            <div class="field"><label>1× (ca. 2048px)</label><input type="file" id="bg-1x" accept=".webp,.jpg,.jpeg,.png"/></div>
            <div class="field"><label>2× (ca. 4096px)</label><input type="file" id="bg-2x" accept=".webp,.jpg,.jpeg,.png"/></div>
          </div>
          <div class="sep"></div>
          <div class="hint">Anvend samme billede på:</div>
          <div class="row" id="bg-apply">
            <label><input type="checkbox" value="home" checked> home</label>
            <label><input type="checkbox" value="om" checked> om</label>
            <label><input type="checkbox" value="roadmap" checked> roadmap</label>
            <label><input type="checkbox" value="rapporter" checked> rapporter</label>
            <label><input type="checkbox" value="default"> default</label>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btn-bg-save">Upload & gem</button>
            <div id="bg-msg" class="hint"></div>
          </div>
        </div>
        <div class="card">
          <h4>Nuværende værdier</h4>
          <div id="bg-list" class="hint">Indlæser…</div>
        </div>
      </div>
    </section>

    <!-- SOCIALE LINKS -->
    <section id="tab-social" class="card hidden">
      <h3>Sociale links</h3>
      <div class="row">
        <div class="hint">Ikoner hentes fra bucket <code>social.icons</code> som <code>Platform.svg</code> (første bogstav stort).</div>
        <div class="row" style="margin-left:auto">
          <label class="btn">
            Upload ikon <input type="file" id="social-icon-file" accept=".svg" style="display:none">
          </label>
          <span id="social-icon-msg" class="hint"></span>
        </div>
      </div>
      <div class="sep"></div>
      <table id="social-table">
        <thead><tr><th>Platform</th><th>URL</th><th>Aktiv</th><th>Sortering</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btn-social-add">+ Tilføj</button>
        <button class="btn primary" id="btn-social-save">Gem alle</button>
        <div id="social-msg" class="hint"></div>
      </div>
    </section>

    <!-- TEKSTER -->
    <section id="tab-text" class="card hidden">
      <h3>Tekster (site_text)</h3>
      <div class="row">
        <div class="field">
          <label>Side</label>
          <select id="txt-page">
            <option>common</option>
            <option>home</option>
            <option>about</option>
            <option>roadmap</option>
            <option>rapporter</option>
          </select>
        </div>
        <button class="btn" id="btn-text-load">Indlæs</button>
        <button class="btn" id="btn-text-add">+ Tilføj nøgle</button>
        <button class="btn primary" id="btn-text-save">Gem</button>
        <div id="text-msg" class="hint"></div>
      </div>
      <div class="sep"></div>
      <table id="text-table">
        <thead><tr><th>Key</th><th>Value (HTML tilladt)</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- YOUTUBE -->
    <section id="tab-yt" class="card hidden">
      <h3>YouTube videoer</h3>
      <div class="grid cols-2">
        <div class="card">
          <div class="field"><label>URL</label><input id="yt-url" placeholder="https://www.youtube.com/watch?v=..." /></div>
          <div class="field"><label>Titel</label><input id="yt-title" placeholder="Visningstitel" /></div>
          <div class="row">
            <div class="field"><label>Sortering</label><input id="yt-sort" type="number" value="1"/></div>
            <label><input id="yt-active" type="checkbox" checked/> Aktiv</label>
          </div>
          <div class="row">
            <button class="btn primary" id="btn-yt-add">Tilføj</button>
            <div id="yt-msg" class="hint"></div>
          </div>
        </div>
        <div class="card">
          <h4>Listen</h4>
          <table id="yt-table">
            <thead><tr><th>Titel</th><th>URL</th><th>Aktiv</th><th>Sort</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="btn-yt-save">Gem ændringer</button>
            <div id="yt-save-msg" class="hint"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- TEAM -->
    <section id="tab-team" class="card hidden">
      <h3>Team (org_people)</h3>
      <div class="hint">Slots: <code>top</code>, <code>mid</code>, <code>accounting</code>, <code>sub1</code>, <code>sub2</code>, <code>sub3</code></div>
      <div class="grid cols-3" id="team-grid"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btn-team-save">Gem team</button>
        <div id="team-msg" class="hint"></div>
      </div>
    </section>

    <!-- PARTNERE -->
    <section id="tab-partners" class="card hidden">
      <h3>Partnere</h3>
      <div class="row">
        <button class="btn" id="btn-partner-add">+ Tilføj partner</button>
        <div class="hint">Upload logoer til bucket <code>people</code> eller indsæt direkte URL.</div>
      </div>
      <div class="sep"></div>
      <table id="partners-table">
        <thead><tr><th>Navn</th><th>Website</th><th>Logo URL</th><th>Alt</th><th>Kategori</th><th>Aktiv</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btn-partners-save">Gem partnere</button>
        <div id="partners-msg" class="hint"></div>
      </div>
    </section>
  </div>

<script>
/* ---------- Supabase ---------- */
const SUPABASE_URL = "https://byrlebjwknppjbtbkozt.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cmxlYmp3a25wcGpidGJrb3p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjcyNjYsImV4cCI6MjA2NzM0MzI2Nn0.3aoQMQgmxXouUfpqrwfSgcUgedjZEue6s3ZkGoqvQYY";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ---------- Gatekeeping: kræver login + admin ---------- */
async function requireAdmin(){
  const sess = await sb.auth.getSession();
  const user = sess?.data?.session?.user;
  if(!user){ window.location.href="/madacoin.html"; return null; }
  const { data, error } = await sb.from('admins').select('id').eq('id', user.id).maybeSingle();
  if(error || !data){ await sb.auth.signOut(); window.location.href="/madacoin.html"; return null; }
  document.getElementById('who').textContent = user.email || 'admin';
  return user;
}
document.getElementById('btn-signout').onclick = async()=>{ await sb.auth.signOut(); window.location.href="/madacoin.html"; };

requireAdmin().then(user=>{ if(user) init(); });

/* ---------- Tabs ---------- */
function initTabs(){
  const tabs=document.getElementById('tabs').querySelectorAll('button');
  tabs.forEach(b=>{
    b.onclick=()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
      document.getElementById('tab-'+b.dataset.tab).classList.remove('hidden');
    };
  });
}

/* ---------- Utils ---------- */
const ext = n => { const i=n.lastIndexOf('.'); return i>-1?n.slice(i+1).toLowerCase():'webp'; };
const toast = (el,msg,ok=true)=>{ el.textContent=msg; el.className = 'hint ' + (ok?'ok':'err'); setTimeout(()=>{ el.textContent=''; el.className='hint'; }, 3000); };

/* ---------- Dashboard ---------- */
async function loadStatus(){
  try{
    const boxes=[];
    const t1= await sb.from('site_text').select('id',{count:'exact',head:true}); boxes.push(`site_text: ${t1.count||0}`);
    const t2= await sb.from('social_links').select('id',{count:'exact',head:true}); boxes.push(`social_links: ${t2.count||0}`);
    const t3= await sb.from('youtube_videos').select('id',{count:'exact',head:true}); boxes.push(`youtube_videos: ${t3.count||0}`);
    const t4= await sb.from('partners').select('id',{count:'exact',head:true}); boxes.push(`partners: ${t4.count||0}`);
    document.getElementById('status-box').textContent = boxes.join(' · ');
  }catch{ document.getElementById('status-box').textContent='—'; }
}

/* ---------- Baggrunde ---------- */
async function loadBackgroundList(){
  const PAGES=['home','om','roadmap','rapporter','default'];
  const keys=[]; PAGES.forEach(p=>keys.push(`bg_${p}_1x`,`bg_${p}_2x`));
  const { data } = await sb.from('site_settings').select('key,value').in('key',keys);
  const map = Object.fromEntries((data||[]).map(r=>[r.key,r.value]));
  const html = PAGES.map(p=>`<div style="margin:6px 0"><b>${p}</b> — 1×: ${map[`bg_${p}_1x`]||'<i>ikke sat</i>'}, 2×: ${map[`bg_${p}_2x`]||'<i>ikke sat</i>'}</div>`).join('');
  document.getElementById('bg-list').innerHTML = html || '<span class="hint">Ingen endnu.</span>';
}
async function saveBackgrounds(){
  const work = document.getElementById('bg-work').value;
  const f1 = document.getElementById('bg-1x').files[0];
  const f2 = document.getElementById('bg-2x').files[0];
  const apply = Array.from(document.querySelectorAll('#bg-apply input:checked')).map(i=>i.value);
  const msg=document.getElementById('bg-msg');
  if(!f1 && !f2){ toast(msg,'Vælg mindst én fil.', false); return; }
  const bucket='backgrounds';
  let url1=null, url2=null;
  if(f1){
    const p1=`bg_${work}_1x_${Date.now()}.${ext(f1.name)}`;
    const { error }=await sb.storage.from(bucket).upload(p1,f1);
    if(error) return toast(msg,error.message,false);
    url1 = `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${p1}`;
  }
  if(f2){
    const p2=`bg_${work}_2x_${Date.now()}.${ext(f2.name)}`;
    const { error }=await sb.storage.from(bucket).upload(p2,f2);
    if(error) return toast(msg,error.message,false);
    url2 = `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${p2}`;
  }
  for(const page of apply){
    if(url1){ const {error}=await sb.from('site_settings').upsert({key:`bg_${page}_1x`, value:url1}); if(error) return toast(msg,error.message,false); }
    if(url2){ const {error}=await sb.from('site_settings').upsert({key:`bg_${page}_2x`, value:url2}); if(error) return toast(msg,error.message,false); }
  }
  toast(msg,'Uploadet & gemt ✅');
  loadBackgroundList();
}

/* ---------- Sociale links ---------- */
async function loadSocial(){
  const { data } = await sb.from('social_links').select('id,platform,url,is_active,sort_order').order('sort_order',{ascending:true});
  const tbody=document.querySelector('#social-table tbody');
  tbody.innerHTML='';
  (data||[]).forEach(r=>tbody.appendChild(socialRow(r)));
}
function socialRow(r={}){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input value="${r.platform||''}" placeholder="Twitter"/></td>
    <td><input value="${r.url||''}" placeholder="https://..."/></td>
    <td><input type="checkbox" ${r.is_active?'checked':''}/></td>
    <td><input type="number" value="${r.sort_order??1}" style="width:90px"/></td>
    <td><button class="btn warn">Slet</button></td>`;
  tr.querySelector('button').onclick = ()=> tr.remove();
  tr.dataset.id = r.id||'';
  return tr;
}
document.getElementById('btn-social-add').onclick=()=>document.querySelector('#social-table tbody').appendChild(socialRow({is_active:true,sort_order:1}));
document.getElementById('btn-social-save').onclick=async()=>{
  const tbody=document.querySelector('#social-table tbody');
  const rows=[...tbody.querySelectorAll('tr')].map(tr=>{
    const [platform,url,active,sort]=tr.querySelectorAll('input');
    return {
      id: tr.dataset.id || undefined,
      platform: platform.value.trim(),
      url: url.value.trim(),
      is_active: active.checked,
      sort_order: parseInt(sort.value||'0',10)
    };
  }).filter(r=>r.platform && r.url);
  const msg=document.getElementById('social-msg');
  try{
    // Simple approach: upsert all, then delete removed ones
    const { data:existing } = await sb.from('social_links').select('id');
    const keepIds = rows.filter(r=>r.id).map(r=>r.id);
    const delIds = (existing||[]).map(x=>x.id).filter(id=>!keepIds.includes(id));
    if(rows.length){ const { error }=await sb.from('social_links').upsert(rows); if(error) throw error; }
    if(delIds.length){ const { error }=await sb.from('social_links').delete().in('id',delIds); if(error) throw error; }
    toast(msg,'Gemt ✅');
    loadSocial();
  }catch(e){ toast(msg,e.message,false); }
};
// ikon upload
document.getElementById('social-icon-file').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const msg=document.getElementById('social-icon-msg');
  const name=f.name; // forvent .svg, Platform.svg
  const { error } = await sb.storage.from('social.icons').upload(name,f,{upsert:true,contentType:'image/svg+xml'});
  if(error) toast(msg,error.message,false); else toast(msg,'Ikon uploadet ✅');
});

/* ---------- Tekster ---------- */
async function loadTexts(){
  const page=document.getElementById('txt-page').value;
  const { data } = await sb.from('site_text').select('id,key,value').eq('page',page).order('key');
  const tbody=document.querySelector('#text-table tbody'); tbody.innerHTML='';
  (data||[]).forEach(r=>tbody.appendChild(textRow(r.key,r.value,r.id)));
}
function textRow(key='',value='',id=''){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td style="width:240px"><input value="${key}" placeholder="about:right_title"/></td>
                <td><textarea>${value||''}</textarea></td>
                <td><button class="btn warn">Slet</button></td>`;
  tr.querySelector('button').onclick=()=>tr.remove();
  tr.dataset.id=id;
  return tr;
}
document.getElementById('btn-text-load').onclick=loadTexts;
document.getElementById('btn-text-add').onclick=()=>document.querySelector('#text-table tbody').appendChild(textRow());
document.getElementById('btn-text-save').onclick=async()=>{
  const page=document.getElementById('txt-page').value;
  const rows=[...document.querySelectorAll('#text-table tbody tr')].map(tr=>{
    const [k,v]=tr.querySelectorAll('input,textarea');
    return { id: tr.dataset.id||undefined, page, key:k.value.trim(), value:v.value };
  }).filter(r=>r.key);
  const msg=document.getElementById('text-msg');
  try{
    // load existing to find deletions
    const { data:existing } = await sb.from('site_text').select('id').eq('page',page);
    const keepIds = rows.filter(r=>r.id).map(r=>r.id);
    const delIds = (existing||[]).map(x=>x.id).filter(id=>!keepIds.includes(id));
    if(rows.length){ const { error }=await sb.from('site_text').upsert(rows); if(error) throw error; }
    if(delIds.length){ const { error }=await sb.from('site_text').delete().in('id',delIds); if(error) throw error; }
    toast(msg,'Gemt ✅');
    loadTexts();
  }catch(e){ toast(msg,e.message,false); }
};

/* ---------- YouTube ---------- */
function ytId(u){ try{ const url=new URL(u); if(url.hostname.includes('youtu.be')) return url.pathname.slice(1);
  if(url.searchParams.get('v')) return url.searchParams.get('v');
  const m=u.match(/(?:embed|shorts)\/([a-zA-Z0-9_-]{6,})/); if(m) return m[1];
  const seg=url.pathname.split('/').pop(); return seg&&seg.length>=6?seg:null; }catch{ return null; } }
async function loadYt(){
  const { data } = await sb.from('youtube_videos').select('id,youtube_url,title,is_active,sort_order').order('sort_order',{ascending:true}).order('created_at',{ascending:false});
  const tb=document.querySelector('#yt-table tbody'); tb.innerHTML='';
  (data||[]).forEach(r=>tb.appendChild(ytRow(r)));
}
function ytRow(r){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input value="${r.title||''}" placeholder="Titel"/></td>
                <td><input value="${r.youtube_url||''}" placeholder="https://..."/></td>
                <td><input type="checkbox" ${r.is_active?'checked':''}/></td>
                <td><input type="number" value="${r.sort_order??1}" style="width:90px"/></td>
                <td><button class="btn warn">Slet</button></td>`;
  tr.dataset.id=r.id;
  tr.querySelector('button').onclick=()=>tr.remove();
  return tr;
}
document.getElementById('btn-yt-add').onclick=async()=>{
  const url=document.getElementById('yt-url').value.trim();
  const title=document.getElementById('yt-title').value.trim();
  const active=document.getElementById('yt-active').checked;
  const sort=parseInt(document.getElementById('yt-sort').value||'1',10);
  const msg=document.getElementById('yt-msg');
  if(!ytId(url)) return toast(msg,'URL ser ikke ud som en YouTube-URL.',false);
  const { error } = await sb.from('youtube_videos').insert({ youtube_url:url, title, is_active:active, sort_order:sort });
  if(error) return toast(msg,error.message,false);
  toast(msg,'Tilføjet ✅'); document.getElementById('yt-url').value=''; document.getElementById('yt-title').value='';
  loadYt();
};
document.getElementById('btn-yt-save').onclick=async()=>{
  const rows=[...document.querySelectorAll('#yt-table tbody tr')].map(tr=>{
    const [t,u,a,s]=tr.querySelectorAll('input');
    return { id:tr.dataset.id, title:t.value, youtube_url:u.value, is_active:a.checked, sort_order:parseInt(s.value||'0',10) };
  });
  const msg=document.getElementById('yt-save-msg');
  try{
    const { data:ex } = await sb.from('youtube_videos').select('id');
    const keep=rows.map(r=>r.id);
    const del=(ex||[]).map(x=>x.id).filter(id=>!keep.includes(id));
    if(rows.length){ const { error }=await sb.from('youtube_videos').upsert(rows); if(error) throw error; }
    if(del.length){ const { error }=await sb.from('youtube_videos').delete().in('id',del); if(error) throw error; }
    toast(msg,'Gemt ✅'); loadYt();
  }catch(e){ toast(msg,e.message,false); }
};

/* ---------- Team ---------- */
const TEAM_SLOTS=['top','mid','accounting','sub1','sub2','sub3'];
function teamCard(p={}){
  const div=document.createElement('div'); div.className='card';
  div.innerHTML=`
    <div class="field"><label>Slot</label><input value="${p.slot||''}" placeholder="top/mid/accounting/sub1"/></div>
    <div class="field"><label>Navn</label><input value="${p.name||''}"/></div>
    <div class="field"><label>Titel</label><input value="${p.title||''}"/></div>
    <div class="field"><label>Foto URL</label><input value="${p.photo_url||''}" placeholder="https://..."/></div>
    <div class="field"><label>Bio (HTML ok)</label><textarea>${p.bio||''}</textarea></div>
    <div class="row">
      <div class="field"><label>Partner ID (valgfri)</label><input value="${p.partner_id||''}" /></div>
      <button class="btn warn" style="margin-top:22px">Ryd</button>
    </div>
  `;
  div.querySelector('button').onclick=()=>{ div.remove(); };
  div.dataset.id = p.id||'';
  return div;
}
async function loadTeam(){
  const { data } = await sb.from('org_people').select('id,slot,name,title,photo_url,bio,partner_id');
  const grid=document.getElementById('team-grid'); grid.innerHTML='';
  // vis i slot-rækkefølge, men tillad ekstra
  TEAM_SLOTS.forEach(s=>{
    const p=(data||[]).find(x=>x.slot===s) || {slot:s};
    grid.appendChild(teamCard(p));
  });
  (data||[]).filter(x=>!TEAM_SLOTS.includes(x.slot)).forEach(p=>grid.appendChild(teamCard(p)));
}
document.getElementById('btn-team-save').onclick=async()=>{
  const cards=[...document.querySelectorAll('#team-grid .card')].map(el=>{
    const inputs=el.querySelectorAll('input,textarea');
    const [slot,name,title,photo_url,bio,partner_id]=inputs;
    return { id:el.dataset.id||undefined, slot:slot.value.trim(), name:name.value.trim(), title:title.value.trim(),
             photo_url:photo_url.value.trim(), bio:bio.value, partner_id:partner_id.value||null };
  }).filter(r=>r.slot);
  const msg=document.getElementById('team-msg');
  try{
    // upsert alle; slet dem med slots der ikke længere findes
    const { data:ex } = await sb.from('org_people').select('id,slot');
    const keepIds = cards.filter(c=>c.id).map(c=>c.id);
    const delIds = (ex||[]).map(x=>x.id).filter(id=>!keepIds.includes(id));
    if(cards.length){ const { error }=await sb.from('org_people').upsert(cards); if(error) throw error; }
    if(delIds.length){ const { error }=await sb.from('org_people').delete().in('id',delIds); if(error) throw error; }
    toast(msg,'Gemt ✅'); loadTeam();
  }catch(e){ toast(msg,e.message,false); }
};

/* ---------- Partnere ---------- */
async function loadPartners(){
  const { data } = await sb.from('partners').select('id,name,website,logo_url,logo_alt,category,active').order('name');
  const tb=document.querySelector('#partners-table tbody'); tb.innerHTML='';
  (data||[]).forEach(p=>tb.appendChild(partnerRow(p)));
}
function partnerRow(p={}){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input value="${p.name||''}"/></td>
    <td><input value="${p.website||''}" placeholder="https://..."/></td>
    <td><input value="${p.logo_url||''}" placeholder="https://..."/></td>
    <td><input value="${p.logo_alt||''}" placeholder="Alt-tekst"/></td>
    <td><input value="${p.category||''}" placeholder="Kategori"/></td>
    <td><input type="checkbox" ${p.active?'checked':''}/></td>
    <td><button class="btn warn">Slet</button></td>`;
  tr.dataset.id=p.id||'';
  tr.querySelector('button').onclick=()=>tr.remove();
  return tr;
}
document.getElementById('btn-partner-add').onclick=()=>document.querySelector('#partners-table tbody').appendChild(partnerRow({active:true}));
document.getElementById('btn-partners-save').onclick=async()=>{
  const rows=[...document.querySelectorAll('#partners-table tbody tr')].map(tr=>{
    const [name,website,logo_url,logo_alt,category,active]=tr.querySelectorAll('input');
    return { id:tr.dataset.id||undefined, name:name.value.trim(), website:website.value.trim(), logo_url:logo_url.value.trim(),
             logo_alt:logo_alt.value.trim(), category:category.value.trim(), active:active.checked };
  }).filter(r=>r.name);
  const msg=document.getElementById('partners-msg');
  try{
    const { data:ex } = await sb.from('partners').select('id');
    const keep=rows.filter(r=>r.id).map(r=>r.id);
    const del=(ex||[]).map(x=>x.id).filter(id=>!keep.includes(id));
    if(rows.length){ const { error }=await sb.from('partners').upsert(rows); if(error) throw error; }
    if(del.length){ const { error }=await sb.from('partners').delete().in('id',del); if(error) throw error; }
    toast(msg,'Gemt ✅'); loadPartners();
  }catch(e){ toast(msg,e.message,false); }
};

/* ---------- Init ---------- */
function init(){
  initTabs();
  loadStatus();

  // BG
  document.getElementById('btn-bg-save').onclick=saveBackgrounds;
  loadBackgroundList();

  // Social
  loadSocial();

  // Tekster
  loadTexts();

  // YouTube
  loadYt();

  // Team
  loadTeam();

  // Partnere
  loadPartners();
}
</script>
</body>
</html>
