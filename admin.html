<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MadaCoin – Admin</title>
  <link rel="preconnect" href="https://unpkg.com" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b0b0c; --panel:#151518; --accent:#3aa0ff; --text:#e9e9ef; --muted:#9aa0a6; --danger:#ff6363; --ok:#4ade80;
      --br:14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; background:var(--bg); color:var(--text); margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; }
    a{ color:var(--accent); text-decoration:none; }
    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    .topbar h1{ font-size:20px; margin:0; }
    .badge{ padding:4px 10px; background:#1f2937; border-radius:999px; border:1px solid #2a3342; color:#cbd5e1; font-size:12px; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    button, .btn{
      background:#1f2937; border:1px solid #2a3342; color:#e5e7eb; padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    button:hover{ border-color:#39485f; }
    .btn.danger{ border-color:#5b2830; background:#2a0f12; color:#ffb4b4; }
    .btn.ok{ border-color:#214d34; background:#0f261a; color:#9ef0c0; }
    input,select,textarea{
      background:#0f1217; border:1px solid #2a3342; color:#e5e7eb; padding:8px 10px; border-radius:10px; width:100%;
    }
    textarea{ min-height:120px; white-space:pre-wrap; }
    .panel{ background:var(--panel); border:1px solid #22242b; border-radius:var(--br); padding:14px; }
    .tabs{ display:flex; gap:8px; margin:10px 0 14px; flex-wrap:wrap; }
    .tab-btn{ padding:8px 12px; border:1px solid #2a3342; background:#14161b; color:#cbd5e1; border-radius:10px; cursor:pointer; }
    .tab-btn.active{ background:#0f1217; border-color:#3aa0ff; color:#e9f2ff; }
    .tab{ display:none; }
    .tab.active{ display:block; }
    table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
    th,td{ text-align:left; padding:6px; }
    th{ color:#b8c0cc; font-weight:600; }
    tr{ background:#101217; }
    tr td:first-child, tr th:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px; }
    tr td:last-child, tr th:last-child{ border-top-right-radius:10px; border-bottom-right-radius:10px; }
    .status{ margin:12px 0; font-size:13px; color:#cbd5e1; }
    .status .ok{ color:var(--ok); }
    .status .err{ color:var(--danger); }
    .grid{ display:grid; gap:10px; grid-template-columns:repeat(12,1fr); }
    .g6{ grid-column:span 6; } .g4{ grid-column:span 4; } .g3{ grid-column:span 3; } .g12{ grid-column:span 12; }
    @media (max-width:960px){ .g6,.g4,.g3{ grid-column:span 12; } }

    /* Login modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:99; }
    .modal{ width:min(480px, 92vw); background:#0e1116; border:1px solid #2a3342; border-radius:16px; padding:18px; }
    .modal h2{ margin:0 0 10px; }
    .modal .hint{ color:#9aa0a6; font-size:12px; margin-top:6px; }
    .modal-backdrop.show{ display:flex; }
    .pill{ display:inline-block; padding:4px 8px; border:1px solid #2a3342; border-radius:999px; color:#aab4c0; font-size:12px; }
    .muted{ color:#a3aab4; }
    .sr{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
    .thumb{ width:64px; height:64px; object-fit:cover; border-radius:10px; border:1px solid #2a3342; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; color:#c7ced8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>MadaCoin – Admin</h1>
      <div class="row">
        <span id="who" class="badge">Ikke logget ind</span>
        <button id="btnSignIn">Log ind</button>
        <button id="btnSignOut" style="display:none">Log ud</button>
      </div>
    </div>

    <div id="gate" class="panel">
      <div class="status" id="gateMsg">Tjekker adgang…</div>
    </div>

    <div id="app" style="display:none">
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-bg">Baggrunde</button>
        <button class="tab-btn" data-tab="tab-social">Sociale links</button>
        <button class="tab-btn" data-tab="tab-text">Tekster</button>
        <button class="tab-btn" data-tab="tab-yt">YouTube</button>
        <button class="tab-btn" data-tab="tab-team">Team</button>
        <button class="tab-btn" data-tab="tab-partners">Partnere</button>
        <button class="tab-btn" data-tab="tab-translate">ChatGPT oversætter</button>
      </div>

      <!-- BAGGRUNDE -->
      <div id="tab-bg" class="tab active">
        <div class="panel">
          <h3>Baggrunde (upload til <code>backgrounds</code>-bucket)</h3>
          <p class="muted">Vælg side + 1×/2×. Upload skriver ind i <code>site_settings</code> (nøgler: <code>home_bg_1x</code>, <code>home_bg_2x</code> osv.).</p>
          <div class="grid">
            <div class="g3">
              <label>Side</label>
              <select id="bgPage">
                <option value="home">home</option>
                <option value="om">om</option>
                <option value="roadmap">roadmap</option>
                <option value="rapporter">rapporter</option>
              </select>
            </div>
            <div class="g3">
              <label>Tæthed</label>
              <select id="bgDensity">
                <option value="1x">1x</option>
                <option value="2x">2x</option>
              </select>
            </div>
            <div class="g6">
              <label>Fil</label>
              <input type="file" id="bgFile" accept="image/*" />
            </div>
            <div class="g12">
              <button id="btnUploadBg">Upload & gem</button>
              <span id="bgStatus" class="status"></span>
            </div>
          </div>
          <div class="grid" style="margin-top:12px">
            <div class="g6">
              <label>Aktuel 1× URL</label>
              <div class="mono" id="curBg1x">–</div>
            </div>
            <div class="g6">
              <label>Aktuel 2× URL</label>
              <div class="mono" id="curBg2x">–</div>
            </div>
          </div>
        </div>
      </div>

      <!-- SOCIALE LINKS -->
      <div id="tab-social" class="tab">
        <div class="panel">
          <div class="row" style="justify-content:space-between">
            <h3>Sociale links</h3>
            <button id="btnAddSocial">+ Tilføj</button>
          </div>
          <table id="tblSocial">
            <thead>
              <tr><th>Platform</th><th>URL</th><th>Aktiv</th><th>Sort</th><th>Handling</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="socialStatus" class="status"></div>
        </div>
      </div>

      <!-- TEKSTER -->
      <div id="tab-text" class="tab">
        <div class="panel">
          <h3>Tekster (site_text)</h3>
          <div class="grid">
            <div class="g3">
              <label>Side</label>
              <select id="txtPage">
                <option value="home">home</option>
                <option value="om">om</option>
                <option value="roadmap">roadmap</option>
                <option value="rapporter">rapporter</option>
              </select>
            </div>
            <div class="g3">
              <label>Sprog</label>
              <select id="txtLang">
                <option value="da">da</option>
                <option value="en">en</option>
                <option value="fr">fr</option>
                <option value="mg">mg</option>
              </select>
            </div>
            <div class="g6" style="align-self:end">
              <button id="btnLoadTexts">Hent</button>
              <button id="btnAddText">+ Tilføj</button>
            </div>
          </div>
          <table id="tblText" style="margin-top:10px">
            <thead>
              <tr><th>Sektion</th><th>Nøgle</th><th>Indhold</th><th>Handling</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="textStatus" class="status"></div>
        </div>
      </div>

      <!-- YOUTUBE -->
      <div id="tab-yt" class="tab">
        <div class="panel">
          <div class="row" style="justify-content:space-between">
            <h3>YouTube (liste)</h3>
            <button id="btnAddYt">+ Tilføj</button>
          </div>
          <table id="tblYt">
            <thead>
            <tr><th>Video ID</th><th>Titel</th><th>Aktiv</th><th>Sort</th><th>Handling</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="ytStatus" class="status"></div>
        </div>
      </div>

      <!-- TEAM -->
      <div id="tab-team" class="tab">
        <div class="panel">
          <div class="row" style="justify-content:space-between">
            <h3>Team (org_people)</h3>
            <button id="btnAddPerson">+ Tilføj</button>
          </div>
          <table id="tblPeople">
            <thead>
              <tr><th>Foto</th><th>Navn</th><th>Rolle</th><th>Bio</th><th>Aktiv</th><th>Sort</th><th>Handling</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="peopleStatus" class="status"></div>
        </div>
      </div>

      <!-- PARTNERE -->
      <div id="tab-partners" class="tab">
        <div class="panel">
          <div class="row" style="justify-content:space-between">
            <h3>Partnere</h3>
            <button id="btnAddPartner">+ Tilføj</button>
          </div>
          <table id="tblPartners">
            <thead>
              <tr><th>Logo</th><th>Navn</th><th>URL</th><th>Aktiv</th><th>Sort</th><th>Handling</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="partnersStatus" class="status"></div>
        </div>
      </div>

      <!-- CHATGPT OVERSÆTTER -->
      <div id="tab-translate" class="tab">
        <div class="panel">
          <h3>ChatGPT oversætter</h3>
          <div class="grid">
            <div class="g12">
              <label for="trSrc">Kildetekst</label>
              <textarea id="trSrc" placeholder="Sæt tekst ind, der skal oversættes…"></textarea>
            </div>
            <div class="g4">
              <label for="trFrom">Fra sprog (valgfri)</label>
              <select id="trFrom">
                <option value="">Auto-detect</option>
                <option>da</option><option>en</option><option>fr</option><option>mg</option>
              </select>
            </div>
            <div class="g4">
              <label for="trTo">Til sprog</label>
              <select id="trTo">
                <option>da</option><option selected>en</option><option>fr</option><option>mg</option>
              </select>
            </div>
            <div class="g4" style="align-self:end">
              <button id="btnTranslate">Oversæt</button>
            </div>
            <div class="g12">
              <label for="trOut">Resultat</label>
              <textarea id="trOut" readonly></textarea>
              <div id="trStatus" class="status"></div>
            </div>
          </div>
          <p class="hint">Kræver Edge Function <code>/functions/v1/translate</code>. Hvis du får 404, mangler den at blive deployet.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Login modal -->
  <div id="loginModal" class="modal-backdrop">
    <div class="modal">
      <h2>Log ind</h2>
      <div class="grid">
        <div class="g12"><label class="sr" for="email">Email</label><input id="email" type="email" placeholder="din@email.com" /></div>
        <div class="g12"><label class="sr" for="password">Password</label><input id="password" type="password" placeholder="Password" /></div>
        <div class="g12 row" style="justify-content:space-between">
          <button id="doLogin" class="btn ok">Log ind</button>
          <button id="closeLogin" class="btn">Luk</button>
        </div>
        <div class="g12 status" id="loginStatus"></div>
      </div>
      <p class="hint">Kun brugere i tabellen <code>admins</code> får adgang.</p>
    </div>
  </div>

  <script>
    // 1) Supabase client
  const SUPABASE_URL = "https://byrlebjwknppjbtbkozt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cmxlYmp3a25wcGpidGJrb3p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjcyNjYsImV4cCI6MjA2NzM0MzI2Nn0.3aoQMQgmxXouUfpqrwfSgcUgedjZEue6s3ZkGoqvQYY";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helpers
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const status = (el, msg, ok=false) => el.innerHTML = msg ? (ok ? `<span class="ok">${msg}</span>` : `<span class="err">${msg}</span>`) : '';

    // UI: Tabs
    $$(".tab-btn").forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$(".tab-btn").forEach(b=>b.classList.remove('active'));
        $$(".tab").forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    // Login modal controls
    const modal = $("#loginModal");
    const openLogin = ()=> modal.classList.add('show');
    const closeLogin = ()=> modal.classList.remove('show');

    $("#btnSignIn").addEventListener('click', openLogin);
    $("#closeLogin").addEventListener('click', closeLogin);
    $("#doLogin").addEventListener('click', async ()=>{
      const email = $("#email").value.trim();
      const password = $("#password").value;
      try{
        status($("#loginStatus"), "Logger ind…", true);
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if(error) throw error;
        closeLogin();
        await gateAdmin(true);
      }catch(e){
        status($("#loginStatus"), e.message || String(e));
      }
    });
    $("#btnSignOut").addEventListener('click', async ()=>{
      await sb.auth.signOut();
      $("#who").textContent = 'Ikke logget ind';
      document.getElementById('app').style.display = 'none';
      document.getElementById('gate').style.display = 'block';
      $("#btnSignOut").style.display = 'none';
      $("#btnSignIn").style.display = 'inline-block';
      $("#gateMsg").innerHTML = 'Log venligst ind for adgang.';
    });

    // 2) Gate: kræver login + membership i `admins`
    async function gateAdmin(refresh){
      const gate = $("#gate"), app = $("#app");
      const who = $("#who"), msg = $("#gateMsg");
      try{
        const { data: { user }, error } = await sb.auth.getUser();
        if(error) throw error;
        if(!user){
          who.textContent = 'Ikke logget ind';
          app.style.display = 'none';
          gate.style.display = 'block';
          msg.innerHTML = 'Ingen session. <button class="btn" onclick="document.getElementById(\'loginModal\').classList.add(\'show\')">Log ind</button>';
          return;
        }
        who.textContent = user.email || user.id;
        $("#btnSignOut").style.display = 'inline-block';
        $("#btnSignIn").style.display = 'none';

        const { data: adminRow, error: e2 } = await sb
          .from('admins')
          .select('user_id,email')
          .eq('user_id', user.id)
          .maybeSingle();
        if(e2) throw e2;
        if(!adminRow){
          app.style.display = 'none';
          gate.style.display = 'block';
          msg.innerHTML = `<span class="err">Du er logget ind, men ikke admin.</span>`;
          return;
        }
        // OK: vis app
        gate.style.display = 'none';
        app.style.display = 'block';
        if(refresh){
          await Promise.all([
            loadBgPreview(),
            loadSocial(),
            loadTexts(),
            loadYt(),
            loadPeople(),
            loadPartners()
          ]).catch(console.error);
        }else{
          // første load
          await Promise.all([
            loadBgPreview(),
            loadSocial(),
            loadTexts(true),
            loadYt(),
            loadPeople(),
            loadPartners()
          ]).catch(console.error);
        }
      }catch(e){
        msg.innerHTML = `<span class="err">${e.message || e}</span>`;
        app.style.display = 'none';
        gate.style.display = 'block';
      }
    }

    // 3) BAGGRUNDE
    async function loadBgPreview(){
      const page = $("#bgPage").value;
      // Hent settings (1x/2x)
      const { data } = await sb.from('site_settings').select('key,value').in('key',[`${page}_bg_1x`, `${page}_bg_2x`]);
      const m = Object.fromEntries((data||[]).map(r=>[r.key,r.value]));
      const one = m[`${page}_bg_1x`], two = m[`${page}_bg_2x`];
      $("#curBg1x").textContent = one ? publicUrl(one.bucket, one.path) : '–';
      $("#curBg2x").textContent = two ? publicUrl(two.bucket, two.path) : '–';
    }
    $("#bgPage").addEventListener('change', loadBgPreview);

    function publicUrl(bucket, path){
      const { data } = sb.storage.from(bucket).getPublicUrl(path);
      return data?.publicUrl || '';
    }

    $("#btnUploadBg").addEventListener('click', async ()=>{
      const page = $("#bgPage").value;
      const density = $("#bgDensity").value; // '1x' | '2x'
      const file = $("#bgFile").files[0];
      if(!file){ status($("#bgStatus"), "Vælg en fil."); return; }
      try{
        status($("#bgStatus"), "Uploader…", true);
        const path = `${page}/bg@${density}${file.name.toLowerCase().endsWith('.webp')?'.webp':'.jpg'}`; // ens navn
        const { error: upErr } = await sb.storage.from('backgrounds').upload(path, file, { upsert:true });
        if(upErr) throw upErr;
        const value = { bucket:'backgrounds', path };
        const key = `${page}_bg_${density}`;
        const { error: setErr } = await sb.from('site_settings').upsert({ key, value });
        if(setErr) throw setErr;
        status($("#bgStatus"), "Gemt ✔", true);
        await loadBgPreview();
      }catch(e){
        status($("#bgStatus"), e.message || String(e));
      }
    });

    // 4) SOCIALE LINKS
    async function loadSocial(){
      const { data, error } = await sb.from('social_links').select('*').order('sort', {ascending:true});
      if(error){ status($("#socialStatus"), error.message); return; }
      const tbody = $("#tblSocial tbody");
      tbody.innerHTML = '';
      (data||[]).forEach(row => addSocialRow(row));
    }
    function addSocialRow(row={}){
      const tbody = $("#tblSocial tbody");
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${row.platform||''}" data-k="platform" placeholder="youtube/x/facebook/…" /></td>
        <td><input value="${row.url||''}" data-k="url" placeholder="https://…" /></td>
        <td><input type="checkbox" data-k="active" ${row.active?'checked':''}></td>
        <td><input type="number" data-k="sort" value="${row.sort??0}" style="max-width:90px"></td>
        <td class="row">
          <button class="btn ok">Gem</button>
          <button class="btn danger">Slet</button>
        </td>
      `;
      tbody.appendChild(tr);
      tr.querySelector('.ok').addEventListener('click', async ()=>{
        const payload = readRow(tr, row.id);
        try{
          const { error } = await sb.from('social_links').upsert(payload);
          if(error) throw error;
          status($("#socialStatus"), "Gemt ✔", true);
          await loadSocial();
        }catch(e){ status($("#socialStatus"), e.message || String(e)); }
      });
      tr.querySelector('.danger').addEventListener('click', async ()=>{
        if(!row.id){ tr.remove(); return; }
        if(!confirm('Slet dette link?')) return;
        try{
          const { error } = await sb.from('social_links').delete().eq('id', row.id);
          if(error) throw error;
          await loadSocial();
        }catch(e){ status($("#socialStatus"), e.message || String(e)); }
      });
    }
    function readRow(tr, id){
      const get = k => tr.querySelector(`[data-k="${k}"]`);
      return {
        id,
        platform: get('platform').value.trim(),
        url: get('url').value.trim(),
        active: get('active').checked,
        sort: parseInt(get('sort').value || '0',10)
      };
    }
    $("#btnAddSocial").addEventListener('click', ()=> addSocialRow({active:true, sort:0}));

    // 5) TEKSTER
    async function loadTexts(skipFetch){
      if(skipFetch!==true){} // placeholder
      const page = $("#txtPage").value, lang=$("#txtLang").value;
      const { data, error } = await sb.from('site_text').select('*')
        .eq('page', page).eq('lang', lang)
        .order('section').order('tkey');
      if(error){ status($("#textStatus"), error.message); return; }
      const tbody = $("#tblText tbody");
      tbody.innerHTML = '';
      (data||[]).forEach(r=> addTextRow(r));
    }
    function addTextRow(row={}){
      const tbody = $("#tblText tbody");
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="min-width:140px"><input value="${row.section||''}" data-k="section" placeholder="fx hero" /></td>
        <td style="min-width:120px"><input value="${row.tkey||''}" data-k="tkey" placeholder="fx title/body" /></td>
        <td><textarea data-k="content" placeholder="Tekst…">${row.content||''}</textarea></td>
        <td class="row">
          <button class="btn ok">Gem</button>
          <button class="btn danger">Slet</button>
        </td>
      `;
      tbody.appendChild(tr);
      tr.querySelector('.ok').addEventListener('click', async ()=>{
        const payload = {
          id: row.id,
          page: $("#txtPage").value,
          lang: $("#txtLang").value,
          section: tr.querySelector('[data-k="section"]').value.trim(),
          tkey: tr.querySelector('[data-k="tkey"]').value.trim(),
          content: tr.querySelector('[data-k="content"]').value
        };
        try{
          const { error } = await sb.from('site_text').upsert(payload, { onConflict:'page,section,tkey,lang' });
          if(error) throw error;
          status($("#textStatus"), "Gemt ✔", true);
          await loadTexts();
        }catch(e){ status($("#textStatus"), e.message || String(e)); }
      });
      tr.querySelector('.danger').addEventListener('click', async ()=>{
        if(!row.id){ tr.remove(); return; }
        if(!confirm('Slet denne tekst?')) return;
        try{
          const { error } = await sb.from('site_text').delete().eq('id', row.id);
          if(error) throw error;
          await loadTexts();
        }catch(e){ status($("#textStatus"), e.message || String(e)); }
      });
    }
    $("#btnLoadTexts").addEventListener('click', loadTexts);
    $("#btnAddText").addEventListener('click', ()=> addTextRow({}));

    // 6) YOUTUBE
    async function loadYt(){
      const { data, error } = await sb.from('youtube_videos').select('*').order('sort',{ascending:true});
      if(error){ status($("#ytStatus"), error.message); return; }
      const tbody = $("#tblYt tbody"); tbody.innerHTML='';
      (data||[]).forEach(r=> addYtRow(r));
    }
    function addYtRow(row={}){
      const tbody = $("#tblYt tbody");
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${row.video_id||''}" data-k="video_id" placeholder="YouTube ID" /></td>
        <td><input value="${row.title||''}" data-k="title" placeholder="Titel" /></td>
        <td><input type="checkbox" data-k="active" ${row.active?'checked':''}></td>
        <td><input type="number" data-k="sort" value="${row.sort??0}" style="max-width:90px"></td>
        <td class="row">
          <button class="btn ok">Gem</button>
          <button class="btn danger">Slet</button>
        </td>
      `;
      tbody.appendChild(tr);
      tr.querySelector('.ok').addEventListener('click', async ()=>{
        const p = {
          id: row.id,
          video_id: tr.querySelector('[data-k="video_id"]').value.trim(),
          title: tr.querySelector('[data-k="title"]').value.trim(),
          active: tr.querySelector('[data-k="active"]').checked,
          sort: parseInt(tr.querySelector('[data-k="sort"]').value || '0',10)
        };
        try{
          const { error } = await sb.from('youtube_videos').upsert(p);
          if(error) throw error;
          status($("#ytStatus"), "Gemt ✔", true);
          await loadYt();
        }catch(e){ status($("#ytStatus"), e.message || String(e)); }
      });
      tr.querySelector('.danger').addEventListener('click', async ()=>{
        if(!row.id){ tr.remove(); return; }
        if(!confirm('Slet denne video?')) return;
        try{
          const { error } = await sb.from('youtube_videos').delete().eq('id', row.id);
          if(error) throw error;
          await loadYt();
        }catch(e){ status($("#ytStatus"), e.message || String(e)); }
      });
    }
    $("#btnAddYt").addEventListener('click', ()=> addYtRow({active:true, sort:0}));

    // 7) TEAM (org_people)
    async function loadPeople(){
      const { data, error } = await sb.from('org_people').select('*').order('sort',{ascending:true});
      if(error){ status($("#peopleStatus"), error.message); return; }
      const tbody = $("#tblPeople tbody"); tbody.innerHTML='';
      (data||[]).forEach(r=> addPersonRow(r));
    }
    function addPersonRow(row={}){
      const tbody = $("#tblPeople tbody");
      const tr = document.createElement('tr');
      const publicPhoto = row.photo_path ? publicUrl('people', row.photo_path) : '';
      tr.innerHTML = `
        <td>${publicPhoto?`<img class="thumb" src="${publicPhoto}" alt="">`:'-'}</td>
        <td><input value="${row.name||''}" data-k="name" placeholder="Navn" /></td>
        <td><input value="${row.role||''}" data-k="role" placeholder="Rolle" /></td>
        <td><textarea data-k="bio" placeholder="Kort bio…">${row.bio||''}</textarea></td>
        <td><input type="checkbox" data-k="active" ${row.active?'checked':''}></td>
        <td><input type="number" data-k="sort" value="${row.sort??0}" style="max-width:90px"></td>
        <td class="row">
          <label class="btn">Upload foto<input type="file" accept="image/*" style="display:none" data-k="file"></label>
          <button class="btn ok">Gem</button>
          <button class="btn danger">Slet</button>
        </td>
      `;
      tbody.appendChild(tr);

      async function savePerson(){
        // upload hvis valgt
        let photo_path = row.photo_path || null;
        const f = tr.querySelector('[data-k="file"]').files[0];
        if(f){
          const path = `p_${Date.now()}_${(f.name||'').replaceAll(' ','_')}`;
          const { error: upErr } = await sb.storage.from('people').upload(path, f, { upsert:true });
          if(upErr) throw upErr;
          photo_path = path;
        }
        const p = {
          id: row.id,
          name: tr.querySelector('[data-k="name"]').value.trim(),
          role: tr.querySelector('[data-k="role"]').value.trim(),
          bio: tr.querySelector('[data-k="bio"]').value,
          active: tr.querySelector('[data-k="active"]').checked,
          sort: parseInt(tr.querySelector('[data-k="sort"]').value || '0',10),
          photo_path
        };
        const { error } = await sb.from('org_people').upsert(p);
        if(error) throw error;
      }

      tr.querySelector('.ok').addEventListener('click', async ()=>{
        try{
          await savePerson();
          status($("#peopleStatus"), "Gemt ✔", true);
          await loadPeople();
        }catch(e){ status($("#peopleStatus"), e.message || String(e)); }
      });
      tr.querySelector('.danger').addEventListener('click', async ()=>{
        if(!row.id){ tr.remove(); return; }
        if(!confirm('Slet denne person?')) return;
        try{
          const { error } = await sb.from('org_people').delete().eq('id', row.id);
          if(error) throw error;
          await loadPeople();
        }catch(e){ status($("#peopleStatus"), e.message || String(e)); }
      });
    }
    $("#btnAddPerson").addEventListener('click', ()=> addPersonRow({active:true, sort:0}));

    // 8) PARTNERE
    async function loadPartners(){
      const { data, error } = await sb.from('partners').select('*').order('sort',{ascending:true});
      if(error){ status($("#partnersStatus"), error.message); return; }
      const tbody = $("#tblPartners tbody"); tbody.innerHTML='';
      (data||[]).forEach(r=> addPartnerRow(r));
    }
    function addPartnerRow(row={}){
      const tbody = $("#tblPartners tbody");
      const tr = document.createElement('tr');
      const logo = row.logo_path ? publicUrl('partners', row.logo_path) : '';
      tr.innerHTML = `
        <td>${logo?`<img class="thumb" src="${logo}" alt="">`:'-'}</td>
        <td><input value="${row.name||''}" data-k="name" placeholder="Navn" /></td>
        <td><input value="${row.url||''}" data-k="url" placeholder="https://…" /></td>
        <td><input type="checkbox" data-k="active" ${row.active?'checked':''}></td>
        <td><input type="number" data-k="sort" value="${row.sort??0}" style="max-width:90px"></td>
        <td class="row">
          <label class="btn">Upload logo<input type="file" accept="image/*" style="display:none" data-k="file"></label>
          <button class="btn ok">Gem</button>
          <button class="btn danger">Slet</button>
        </td>
      `;
      tbody.appendChild(tr);

      async function savePartner(){
        let logo_path = row.logo_path || null;
        const f = tr.querySelector('[data-k="file"]').files[0];
        if(f){
          const path = `l_${Date.now()}_${(f.name||'').replaceAll(' ','_')}`;
          const { error: upErr } = await sb.storage.from('partners').upload(path, f, { upsert:true });
          if(upErr) throw upErr;
          logo_path = path;
        }
        const p = {
          id: row.id,
          name: tr.querySelector('[data-k="name"]').value.trim(),
          url: tr.querySelector('[data-k="url"]').value.trim(),
          active: tr.querySelector('[data-k="active"]').checked,
          sort: parseInt(tr.querySelector('[data-k="sort"]').value || '0',10),
          logo_path
        };
        const { error } = await sb.from('partners').upsert(p);
        if(error) throw error;
      }

      tr.querySelector('.ok').addEventListener('click', async ()=>{
        try{
          await savePartner();
          status($("#partnersStatus"), "Gemt ✔", true);
          await loadPartners();
        }catch(e){ status($("#partnersStatus"), e.message || String(e)); }
      });
      tr.querySelector('.danger').addEventListener('click', async ()=>{
        if(!row.id){ tr.remove(); return; }
        if(!confirm('Slet denne partner?')) return;
        try{
          const { error } = await sb.from('partners').delete().eq('id', row.id);
          if(error) throw error;
          await loadPartners();
        }catch(e){ status($("#partnersStatus"), e.message || String(e)); }
      });
    }
    $("#btnAddPartner").addEventListener('click', ()=> addPartnerRow({active:true, sort:0}));

    // 9) ChatGPT oversætter (Edge Function)
    async function translateText(text, targetLang, sourceLang){
      const { data: { session } } = await sb.auth.getSession();
      if(!session) throw new Error('Login kræves.');
      const url = `${SUPABASE_URL}/functions/v1/translate`;
      const res = await fetch(url, {
        method:'POST',
        headers:{
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ text, targetLang, sourceLang })
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error(`Translate fejlede (${res.status}): ${t}`);
      }
      const json = await res.json();
      return json.translation || '';
    }
    $("#btnTranslate").addEventListener('click', async ()=>{
      const src = $("#trSrc").value, to = $("#trTo").value, from = $("#trFrom").value || undefined;
      try{
        status($("#trStatus"), "Oversætter…", true);
        const out = await translateText(src, to, from);
        $("#trOut").value = out;
        status($("#trStatus"), "Færdig ✔", true);
      }catch(e){
        status($("#trStatus"), e.message || String(e));
      }
    });

    // 10) Første load
    (async ()=>{
      // Autoåbn login hvis ingen session
      const { data: { user } } = await sb.auth.getUser();
      if(!user) openLogin();
      await gateAdmin(true);
    })();
  </script>
</body>
</html>
