<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MadaCoin</title>
  <link rel="preconnect" href="https://unpkg.com" />
  <script src="https://unpkg.com/@supabase/supabase-js@2" crossorigin="anonymous"></script>
  <style>
    :root{
      --wrap:1280px; --gap:24px;
      --rail-w: 260px;       /* venstre rail bredde */
      --panel:#0f1217; --ink:#e9e9ef; --muted:#9aa0a6; --line:#1f2735; --accent:#3aa0ff;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:#0b0b0c; color:var(--ink); font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; }
    a{ color:var(--accent); text-decoration:none; }
    .wrap{ max-width:var(--wrap); margin:0 auto; padding:0 16px; }

    /* NAV */
    .nav{ position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(4px); background:rgba(11,11,12,.65); border-bottom:1px solid var(--line); }
    .nav-inner{ display:flex; align-items:center; gap:18px; padding:12px 0; }
    .nav a{ color:#cfe3ff; font-weight:600; }
    .nav a:hover{ text-decoration:underline; }

    /* VENSTRE SOCIAL RAIL */
    .social-rail{ position:fixed; left:0; top:76px; width:var(--rail-w); padding:10px 10px 10px 14px; }
    .social{ display:flex; flex-direction:column; gap:8px; }
    .social a{ display:flex; align-items:center; gap:8px; color:var(--muted); padding:6px 8px; border:1px dashed transparent; border-radius:10px; }
    .social a:hover{ border-color:var(--line); color:#cbd5e1; }

    /* LAYOUT GRID */
    .main{ display:grid; grid-template-columns: minmax(0,1fr); gap:var(--gap); margin:16px 0 80px; }
    .content{ margin-left: calc(var(--rail-w) + 8px); } /* plads til venstre rail */

    /* TOP: Mønter + YouTube centreret */
    .top{ display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); align-items:start; }
    .panel{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:14px; }
    .coins{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .coin{ background:#0b0d12; border:1px solid #1a2330; border-radius:14px; padding:12px; }
    .coin h3{ margin:0 0 6px; font-size:16px; }
    .coin p{ margin:6px 0 0; color:#cbd5e1; }

    .yt{ }
    .yt-main{ aspect-ratio:16/9; width:100%; border:0; border-radius:12px; background:#000; display:block; }
    .yt-thumbs{ display:flex; gap:10px; margin-top:10px; overflow:auto; padding-bottom:2px; }
    .yt-thumb{ width:120px; height:68px; border-radius:8px; border:1px solid #202a3a; object-fit:cover; cursor:pointer; }

    /* “VENSTRE RAIL” FOR HERO + GRAF (placeret i indholdets venstre side) */
    .rail{ display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); align-items:start; }
    .hero h2{ margin:0 0 6px; font-size:20px; }
    .hero p{ margin:8px 0 0; color:#cbd5e1; white-space:pre-wrap; }
    .graph{ min-height:180px; display:grid; place-items:center; color:#acb4bf; border:1px dashed #243044; border-radius:12px; }

    /* FOOTER sticky */
    footer{ position:sticky; bottom:0; background:rgba(11,11,12,.65); border-top:1px solid var(--line); padding:10px 0; color:#9aa0a6; }

    /* Responsiv */
    @media (max-width:1100px){
      :root{ --rail-w: 0px; }
      .content{ margin-left: 0; }
      .social-rail{ position:static; width:auto; padding:0; margin:8px 0 -6px; }
      .social{ flex-direction:row; flex-wrap:wrap; }
    }
    @media (max-width:860px){
      .top{ grid-template-columns: 1fr; }
      .coins{ grid-template-columns: 1fr; }
      .rail{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="wrap nav-inner">
      <a href="/">Home</a>
      <a href="/madacoin.html">Om</a>
      <a href="/roadmap.html">Roadmap</a>
      <a href="/rapporter.html">Rapporter</a>
    </div>
  </div>

  <!-- VENSTRE SOCIAL RAIL -->
  <aside class="social-rail">
    <div class="social" id="social-menu">
      <!-- Fyldes fra Supabase: social_links -->
    </div>
  </aside>

  <!-- INDHOLD -->
  <main class="wrap main">
    <section class="content">
      <!-- TOP: Mønter + YouTube (centreret i indholdet) -->
      <div class="top">
        <div class="panel">
          <h2 style="margin:0 0 10px">Mønter</h2>
          <div class="coins">
            <div class="coin">
              <h3 id="mcd-title">MCD</h3>
              <p id="mcd-body">Tekst fra <code>site_text</code> (page=home, section=mcd)</p>
            </div>
            <div class="coin">
              <h3 id="mcn-title">MCN</h3>
              <p id="mcn-body">Tekst fra <code>site_text</code> (page=home, section=mcn)</p>
            </div>
          </div>
        </div>
        <div class="panel yt">
          <h2 style="margin:0 0 10px">YouTube</h2>
          <iframe id="yt-main" class="yt-main" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          <div class="yt-thumbs" id="yt-thumbs">
            <!-- Fyldes fra Supabase: youtube_videos -->
          </div>
        </div>
      </div>

      <!-- “VENSTRE RAIL” (hero + graf) -->
      <div class="rail" style="margin-top:16px">
        <div class="panel hero">
          <h2 id="hero-title">Hero-titel</h2>
          <p id="hero-body">Hero-tekst fra <code>site_text</code> (page=home, section=hero)</p>
        </div>
        <div class="panel graph" id="graph-box">
          <div>Graf (placeholder)</div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="wrap">© MadaCoin</div>
  </footer>

  <script>
    // ===== Supabase klient =====
    const SUPABASE_URL = "https://byrlebjwknppjbtbkozt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cmxlYmp3a25wcGpidGJrb3p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjcyNjYsImV4cCI6MjA2NzM0MzI2Nn0.3aoQMQgmxXouUfpqrwfSgcUgedjZEue6s3ZkGoqvQYY";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Hjælpere =====
    const $ = s => document.querySelector(s);
    function publicUrl(bucket, path){
      const { data } = sb.storage.from(bucket).getPublicUrl(path);
      return data?.publicUrl || '';
    }

    // ===== Social links (venstre rail) =====
    async function loadSocial(){
      const { data, error } = await sb.from('social_links').select('*').eq('active', true).order('sort', {ascending:true});
      const box = $('#social-menu'); box.innerHTML = '';
      if(error){ box.innerHTML = `<div style="color:#ff6363">Social fejl: ${error.message}</div>`; return; }
      (data||[]).forEach(row=>{
        const a = document.createElement('a');
        a.href = row.url; a.target = "_blank"; a.rel = "nofollow noopener";
        a.textContent = row.platform;
        box.appendChild(a);
      });
    }

    // ===== Tekster (hero + mcd/mcn) =====
    async function loadTexts(){
      const { data, error } = await sb.from('site_text').select('section,tkey,content').eq('page','home');
      if(error){ console.warn('site_text error:', error); return; }
      const lookup = {};
      (data||[]).forEach(r=>{ lookup[`${r.section}:${r.tkey}`] = r.content; });
      $('#hero-title').textContent = lookup['hero:title'] || 'Hero-titel';
      $('#hero-body').textContent  = lookup['hero:body']  || 'Hero-tekst…';
      $('#mcd-title').textContent  = lookup['mcd:title']  || 'MCD';
      $('#mcd-body').textContent   = lookup['mcd:body']   || 'Donation token…';
      $('#mcn-title').textContent  = lookup['mcn:title']  || 'MCN';
      $('#mcn-body').textContent   = lookup['mcn:body']   || 'Crypto token…';
    }

    // ===== YouTube (hoved + thumbs) =====
    function setMainVideo(id){
      const src = id ? `https://www.youtube-nocookie.com/embed/${id}` : '';
      $('#yt-main').src = src;
    }
    async function loadYouTube(){
      const { data, error } = await sb.from('youtube_videos').select('*').eq('active', true).order('sort', {ascending:true});
      const thumbs = $('#yt-thumbs'); thumbs.innerHTML = '';
      if(error){ console.warn('youtube error:', error); return; }
      const list = data || [];
      if(list.length === 0){ setMainVideo(''); return; }
      setMainVideo(list[0].video_id);
      list.forEach(v=>{
        const img = new Image();
        img.src = `https://i.ytimg.com/vi/${v.video_id}/hqdefault.jpg`;
        img.alt = v.title || v.video_id;
        img.className = 'yt-thumb';
        img.addEventListener('click', ()=> setMainVideo(v.video_id));
        thumbs.appendChild(img);
      });
    }

    // ===== Baggrund fra site_settings (home_bg_1x/2x) =====
    async function applyBackground(){
      const { data, error } = await sb.from('site_settings').select('key,value').in('key',['home_bg_1x','home_bg_2x']);
      if(error){ console.warn('site_settings error:', error); return; }
      const map = Object.fromEntries((data||[]).map(r=>[r.key,r.value]));
      const one = map['home_bg_1x'], two = map['home_bg_2x'];
      if(one || two){
        const url1 = one ? `url("${publicUrl(one.bucket, one.path)}") 1x` : null;
        const url2 = two ? `url("${publicUrl(two.bucket, two.path)}") 2x` : null;
        const imageSet = [url1,url2].filter(Boolean).join(', ');
        document.body.style.backgroundImage = two ? `image-set(${imageSet})` : (one ? `url("${publicUrl(one.bucket, one.path)}")` : '');
        document.body.style.backgroundAttachment = 'fixed';
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
      }
    }

    // ===== Init =====
    (async ()=>{
      await Promise.all([loadSocial(), loadTexts(), loadYouTube(), applyBackground()]);
    })();
  </script>

  <!-- Password reset handler (Supabase) -->
  <script>
    // Lille overlay-UI til at sætte nyt password (vises når reset-link åbnes)
    const resetCss = `
      .reset-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999}
      .reset-card{width:min(480px,92vw);background:#0e1116;color:#e9e9ef;border:1px solid #2a3342;border-radius:14px;padding:18px;font:14px system-ui}
      .reset-card h2{margin:0 0 10px}
      .reset-card input{width:100%;margin:8px 0;padding:10px;border-radius:10px;border:1px solid #2a3342;background:#0f1217;color:#e5e7eb}
      .reset-row{display:flex;gap:10px;justify-content:flex-end}
      .reset-btn{background:#1f2937;border:1px solid #2a3342;color:#e5e7eb;padding:8px 12px;border-radius:10px;cursor:pointer}
      .reset-btn.ok{border-color:#214d34;background:#0f261a;color:#9ef0c0}
      .reset-status{margin-top:8px;color:#cbd5e1}
      .reset-status.err{color:#ff6363}
    `;
    (function injectStyle(css){ const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s); })(resetCss);

    function showResetModal(){
      const wrap = document.createElement('div');
      wrap.className = 'reset-backdrop';
      wrap.innerHTML = `
        <div class="reset-card">
          <h2>Sæt nyt password</h2>
          <p>Indtast et nyt password til din konto.</p>
          <input id="rp1" type="password" placeholder="Nyt password" />
          <input id="rp2" type="password" placeholder="Gentag password" />
          <div class="reset-row">
            <button class="reset-btn" id="rp-cancel">Luk</button>
            <button class="reset-btn ok" id="rp-save">Gem</button>
          </div>
          <div class="reset-status" id="rp-status"></div>
        </div>
      `;
      document.body.appendChild(wrap);

      const $w = sel => wrap.querySelector(sel);
      $w('#rp-cancel').onclick = () => wrap.remove();
      $w('#rp-save').onclick = async () => {
        const p1 = $w('#rp1').value, p2 = $w('#rp2').value;
        const st = $w('#rp-status');
        if(!p1 || p1.length < 8){ st.textContent = "Password skal være mindst 8 tegn."; st.className='reset-status err'; return; }
        if(p1 !== p2){ st.textContent = "Passwords matcher ikke."; st.className='reset-status err'; return; }
        try{
          st.textContent = "Opdaterer…"; st.className='reset-status';
          const { error } = await sb.auth.updateUser({ password: p1 });
          if(error) throw error;
          st.textContent = "Færdig! Du kan nu logge ind i admin med dit nye password.";
          st.className='reset-status';
          setTimeout(()=> wrap.remove(), 1400);
        }catch(e){
          st.textContent = e.message || String(e);
          st.className='reset-status err';
        }
      };
    }

    // FANG reset-token fra Supabase: #access_token=…&refresh_token=…&type=recovery
    (async ()=>{
      const hash = window.location.hash || "";
      const params = new URLSearchParams(hash.startsWith('#') ? hash.slice(1) : hash);
      const type = params.get('type');
      const access_token = params.get('access_token');
      const refresh_token = params.get('refresh_token');

      if (type === 'recovery' && access_token) {
        try{
          // Etabler session ud fra token i URL (krævet før updateUser)
          await sb.auth.setSession({ access_token, refresh_token });
        }catch(e){ console.warn("setSession fejl:", e); }
        // Ryd hash for pæn URL
        try{ window.history.replaceState({}, document.title, window.location.pathname + window.location.search); }catch(_){}
        // Vis modal
        showResetModal();
      }
    })();
  </script>
</body>
</html>
